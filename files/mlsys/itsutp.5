; T S UTAPE ROUTINES PI SERV

TAPE:	0
UTP1:	0	;JRST PIPOS OR DATAI DC, OR JRST UTP3

BBLK

	SOS .-1
	AOSGE TAPCNT
	JRST 12,@TAPE

UTP3:	CONO DTS,770001
	JRST 12,@TAPE

PIPOS:	MOVEM A,TAP1
	MOVEM B,TAP2
	MOVEM C,TAP3
	MOVE C,SUNIT
	DATAI DTC,B
	TDZE B,[1777#-1]
	JRST PIPOS7
	MOVEM B, EUPOS(C)
	HRRZM C, DG2(C)
	SKIPGE UGOAL(C)
	JRST PIPF1
	SUB B,UGOAL(C)
	JUMPE B,PIPOS2
	ADD B,UDIR(C)
	MOVMM B,UTENB
	SKIPGE ULDCH(C)
	JRST PIPOS3
	JUMPN B,PIPOS3
PIPOSL:	MOVEI A,40000+DCCHN_3
	DPB C,[110300,,A]	;SET SELECTED UNIT CONO DTC,FOO(A)
	MOVE B,UDIR(C)
	XCT UTST2(B)
PIPOS5:	MOVE C,TAP3
	MOVE B,TAP2
	MOVE A,TAP1
	JRST 12,@TAPE

PIPOS7:	AOS BDBLKC
	JRST PIPOSL

EBLK

BDBLKC:	0
BBLK

PIPOS3:	MOVE A,UDIR(C)
	LSH A,2
	SUB B,A
	XOR B,UDIR(C)
	MOVEI A,40000
	DPB C,[110300,,A]
	JUMPG B,PIPOS4	;GOING WRONG DIR
PIPOS6:	MOVE B,TIME
	MOVEM B,ULCTM(C)
	ADD B,UTENB
	MOVEM B,DRTM(C)
PIPF2:	MOVE B,UDIR(C)
	TRNN A,40000
	TRO A,30000
	XCT  UTST2(B)
;	CLEARM UDCC
;	SETOM DCFREE
	CONO DTS,770001	;ENABLE ALL INTERUPTS AND SET FUNCTION STOP
	JRST PIPOS5

PIPF1:	MOVEI A,40000
	DPB C,[110300,,A]
	MOVE B,TIME
	MOVEM B,ULCTM(C)
	JRST PIPF2
PIPOS4:	TRZ A,40000	;TURN TAPE AROUND
	CLEARM DG2(C)
	MOVNS B,UDIR(C)
	MOVEM B,OUDIR(C)
	JRST PIPOS6

PIPOS2:	HLRZ A,ULDCH(C)
	SKIPL ULDCH(C)
	SKIPGE UTRAC(A)
	JRST PIPOS3	;CHANNEL LOCKED
	SETOM UTLDD(A)	;CHANNEL ACTUALLY LOADED TRANSFER IMMINENT
	AOS SMODE
	MOVEI A,0
	MOVE B,UMEMAD(C)
	SKIPGE URDWR(C)
	TROA A,400	;WRITE
	TLZ B,(BLKO-BLKI)
	SKIPL UDIR(C)
	JRST TAPFOR
	TRO A,100000
	ADD B,[DATAI-BLKI 200]
	MOVEM B,UTP1
	MOVNI B,200
	MOVEM B,TAPCNT

TAP4:	CONO DTC,300+DCCHN_3+UTCCHN(A)
	CONO DTS,770000
	MOVE B,URDWR(C)
	MOVEM B,WRITE
	MOVE C,TAP3
	MOVE B,TAP2
	MOVE A,TAP1
	JRST 12,@TAPE

TAPFOR:	TRO A,200000
	HRRM B,TAPCNT
	HRRI B,TAPCNT
	MOVEM B,DCMLOC
	MOVE B,[-200,,UTP3]
	HRRM B,UTP1
	HLLM B,TAPCNT
	JRST TAP4
UTERR:	CONI DTS,E
	SKIPL SMODE
	JRST UDATER
;	SKIPGE UDCC
;	SETOM DCFREE
UTER5:	SKIPN C,SUNIT
	JRST JDB3
	SETOM DG2(C)
	SKIPL UFLAPF(C)
	JRST UTER6
	CLEARM UFLAPF(C)
	CLEARM EUPOS(C)
	CLEARM UDIR(C)
	CLEARM OUDIR(C)
	CONO DTC,400000	;STOP DRIVE
	JRST JDB3

UTER6:	AOS UTERP(C)
	HRLM E,UTERP(C)
	TRNN E,20000
	JRST JDB3	;END ZONE
	MOVNS B,UDIR(C)
	MOVEI A,0
	SKIPGE B
	MOVEI A,1103
	MOVEM A,EUPOS(C)
	MOVE A,TIME
	MOVEM A,ULCTM(C)
	MOVEM A,DRTM(C)
	JRST JDB7

UDATER:	CONO DTS,770001	;ENABLE ALL INTERUPTS AND STOP FUNCTION
	SETOM SMODE
	HLRZ D,ULDCH(C)
	CLEARM UTLDD(D)
	JRST JDB3
UTCB0:	MOVE C,SUNIT
	AOSE CUINT	;SKIP IF CLOCK CAUSED INTERUPT
	JRST JDBRK	;NOT TIME FLAG
UTCB1:	MOVE B,UDIR(C)
	AOSN UTHERR	;HANG UP ERROR SENT FOR SLOW CLOCK ROUTINE
	JRST UTERR
	JRST JDB3

JDDT3:	MOVE A,EUPOS(C)	;AFTER DATA XFER
	SUB A,UGOAL(C)
	MOVMS E,A
	ADD A,TIME
	MOVEM A,DRTM(C)
	MOVE C,[-NUNITS,,1]
	MOVM B,DRTM(C)
	CAMGE B,TIME
	JRST JDB3	;SOMETHING ELSE DUE
	AOBJN C,.-3
	MOVE C,SUNIT
	SOJLE E,JDB7	;RELOADING FOR NEXT BLOCK
	JRST JDB3
ILLP:	MOVEM D,UGOAL(C)	;LOW PRIORITY POSIT ENTRY
	MOVSI A,(SETZ)
	IORM A,ULDCH(C)

UTDC:	SKIPGE UGOAL(C)
	POPJ P,	;UNIT IDLE
	SKIPGE DG2(C)
	JRST UTDC3
UTDC1:	MOVE A,EUPOS(C)	;ESTIMATE UNIT TIME AND UPDATE EUPOS
	SKIPG DG2(C)	;SKIP ON EXACT POS KNOWN
	SKIPN UDIR(C)	;SKIP ON UNIT RUNNING
	JRST UTDC4
	MOVE B,TIME
	SUBM B,ULCTM(C)
	EXCH B,ULCTM(C)
	IMUL B,UDIR(C)
	ADD A,B	;ACTUAL ESTIMATED POSITION
	MOVEM A,EUPOS(C)	;UPDATE EUPOS
UTDC4:	SUB A,UGOAL(C)
	MOVM B,A
	CAIG B,2
	JRST UTDC2
	ADD A,UDIR(C)
	MOVMS Aî	
	CAMLE A,B
	SETZB A,B	;GOING WRONG DIR
UTDC2:	CAILE B,200.
	MOVEI B,200.	;LIMIT LONGEST DEAD RECKON
	ADD B,TIME
	MOVEM B,DRTM(C)
	POPJ P,

UTDC3:	MOVEI B,0	;NOT KNOWN EXACT POS REQUIRES IMMEDIATE ATTENTION
	JRST UTDC2

JDBRK:	CONSO DTS,2
	JRST POPRET
	CONSZ DTS,670300
	JRST UTERR
	CONSO DTS,100000
	JRST POPRET
	SKIPL SMODE
	JRST JDDTA	;DATA MODE
JDB3:
;	SKIPGE UDCC
;	SETOM DCFREE
	HRLOI B,177777
	MOVEM B,UTTM2
	SETOM UTTM3	;UNIT MOST URGENT
	CLEARM UTTM1	;UNIT COULD START
	MOVE C,[-NUNITS,,1]
JDBRK7:	SKIPGE B,UFLAPF(C)
	JRST JDF1	;FLAPPING OP
JDF2:	SKIPL ULDCH(C)	;SKIP ON LOW PRIOR POSIT
	SKIPGE UGOAL(C)
	JRST JDB6	;UNIT FREE
JDS1:	SKIPE UDIR(C)
	JRST JDBRK4
	SKIPN UTTM1	;UNIT TO START
	HRRZM C,UTTM1
	JRST JDBRK6
JDBRK4:	MOVE B,DRTM(C)
	SUB B,TIME
	MOVE E,B
	SUB E,UTTM2	;TIME SMOE OTHER UNIT NEEDS ATTN
	JUMPL B,JDCV1	;ALREADY OVERDUE
	MOVM D,E
	CAIG B,20.	;CONFLICT MORE THAN 20 BLKS AWAY
	CAIL D,20.	;THEY ARE SEPARETED BY 20 BLKS
	JRST JDCV1
	HRRZS C	;RELIEVE CONFLICT BY STOPPING UNIT DUE LATEST
	CAMG B,UTTM2
	HRRZ C,UTTM3
JDF5:	PUSHJ P,JDSTP	;STOP UNIT
	JRST JDB3

JDCV1:	JUMPGE E,ULLP
	MOVEM B,UTTM2	;UNIT DUE SOONEST
	HRRZM C,UTTM3
ULLP:	SKIPL ULDCH(C)
	JRST JDBRK6
	MOVE B,TIME	;LOW PRIORITY POSIT IN PROGRESS
	SUB B,ULCTM(C)
	IMUL B,UDIR(C)
	SKIPE DG2(C)
	MOVEI B,0
	ADD B,EUPOS(C)
	SUB B,UGOAL(C)
	MOVMS B
	CAIGE B,10.
	PUSHJ P,ULLP1	;TERM LOW PRIORITY DIRECTORY POS (COMMIT TO ACTUAL WRITE)
JDBRK6:	AOBJN C,JDBRK7
	MOVE C,UTTM3	;MOST PRESSING RUNNING UNIT
	MOVE B,UTTM2
	CAIGE B,30.
	JRST JDB7	;STAY WITH PRESSING UNIT
	SKIPE UTTM1
	JRST JDB5	;START UNIT IF POSSIBLE
JDF6A:	CAMG B,[10000000.]
	JRST JDB7
	SETOM UIDLE
	JRST POPRET

JDF1:	MOVE E,UDIRO(C)
	AOJE E,JDF1A
	TLNE E,100000
	JRST JDF2
JDF1A:	SKIPGE UGOAL(C)	;FLAPPING OP
	SKIPGE ULDCH(C)
	JRST JDF2
	SKIPE UDIR(C)
	SKIPG DG2(C)
	JRST .+2
	JRST JDF3A	;HAVE JUST READ IN TAPE POS
	TLNN B,100000
	JRST JDF3	;UNIT TO START FLAPPING (I.E. READ IN TAPE POS, THEN FLAP)
	LDB D,[4000,,B]
	TLNN B,100000
	JRST JDBRK6
	TLNN B,200000	;ABORT FLAPPING
	CAMG D,TIME
	JRST JDF4	;UNIT TO STOP FLAPPING
	JRST JDBRK6

JDDS:	CONO DTC,10000	;DESELECT
	CLEARM SUNIT
	POPJ P,

JDSTP:	MOVEI A,430000
	SETZM UDIR(C)
	SETZM OUDIR(C)
JDCNN:	HRRZS C
	CAME C,SUNIT	;DIR CONO IN A TO UNIT IN C
	SKIPN SUNIT
	JRST JDSTP1
	PUSHJ P,JDDS
JDSTP1:	DPB C,[110300,,A]
	CONO DTC,(A)
	MOVEM C,SUNIT
	POPJ P,

JDF3:	MOVE A,UDIRO(C)	;WANT TO FLAP
	AOJE A,JDF3A1	;DIR NOT IN
	TLNE A,10000
	JRST JDF3A2	;DIR ON WAY IN
	HRRZ A,ULDCH(C)
	LDB Q,[IOCH,,IOBFT(A)]
	CAIE Q,NUTIC+NUTOC
	JRST 4,.
	LDB Q,[IOLO,,IOBFT(A)]
	CAIE Q,(C)
	JRST 4,.
	PUSHJ P,IBRTN	;RETURN DIR BUFFER
JDF3A2:	SETOM UDIRO(C)
	SETZM UTASS(C)
JDF3A1:	SETOM UDPWF(C)
	SKIPGE DG2(C)
	JRST JDF6
JDF3A:	SETOM DG2(C)	;FLAP UNIT INC(KNOWING WHERE IT IS)
	MOVE E,EUPOS(C)
	IMULI E,50.	;50 MS/BLOCK
	IDIVI E,33.	;33 MS/(1/2 SEC)
	ADDI E,30.	;15 SECS EXTRA
	ADD E,TIME	;NET TIME TO STOP FLAPPING
	TLO E,100000
	DPB E,[4200,,UFLAPF(C)]
	LSH C,9.
	CONO DTC,130000(C)	;GO REVERSE
	PUSHJ P,JDDS
	JRST JDB3

JDF6:	HRRZS C
	SETOM UDIR(C)
	JRST JDB7

JDF4:	TLNE B,40000
	JRST JDF4A
	MOVEI A,230000	;A SHOT OF FOWARD
	PUSHJ P,JDCNN	;REEL WILL STOP
	AND B,[700000,,]
	ADD B,[40000,,2]
	ADD B,TIME
	MOVEM B,UFLAPF(C)
	JRST JDB3

JDF4A:	PUSHJ P,JDSTP
	CLEARM UFLAPF(C)
	CLEARM EUPOS(C)
	SETOM DG2(C)
	JRST JDF5
JDB5:	HRRZ C,UTTM1
	MOVE E,UGOAL(C)
	CAML E,EUPOS(C)
	SKIPA B,[1]
	MOVNI B,1
	MOVEM B,UDIR(C)
JDB7:	SKIPN B,UDIR(C)
	JRST 4,.	;NOT TRYING TO GO
	MOVEI A,DCCHN_3
	SKIPN SUNIT
	JRST DCGB1
	CAME C,SUNIT
	JRST DCGB2
	CAMN B,OUDIR(C)
	TRO A,40000	;INHIBIT START DELAY (SAME UNIT, SAME DIRECTION)
DCGB1:	MOVEM C,SUNIT
	MOVEM B,OUDIR(C)
	TRNN A,40000
	TRO A,30000
	DPB C,[110300,,A]
	XCT UTST2(B)
	CONO DTS,770000
	MOVE C,[JSR TAPE]
	MOVEM C,DCMLOC
	MOVEM C,DCMLOC+1
	MOVE C,[JRST PIPOS]
	MOVEM C,UTP1
	JRST POPRET

DCGB2:	PUSHJ P,JDDS
	JRST DCGB1

	CONO DTC,130200+UTCCHN+<DCCHN_3>(A)
UTST:	CONO DTC,430000+UTCCHN+<DCCHN_3>(A)
	CONO DTC,230200+UTCCHN+<DCCHN_3>(A)

	CONO DTC,130200+UTCCHN(A)
UTST1:	CONO DTC,430000+UTCCHN(A)
	CONO DTC,230200+UTCCHN(A)

	CONO DTC,100200+UTCCHN(A)
UTST2:	CONO DTC,400000+UTCCHN(A)
	CONO DTC,200200+UTCCHN(A)

