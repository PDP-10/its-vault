;;; -*-Mode:LISP; Package:USER; Base: 10. -*-
;THIS FILE READ INTO MACHINE TO DEFINE MACROS FOR LCHESS SYSTEM
; THEREFORE, SPECIAL DECLARATIONS SHOULD BE MINUS DECLARE S.

;SQUARE NUMBER
;  BOARD IS A 10. BY 12. ARRAY, WITH BORDER OF OFF-BOARD SQUARES
; IF SQUARE HAS VALUE OF SQUARE-OFF-BOARD, IT IS PART OF THE BORDER.
; IF SQUARE-VACANT, IT IS.  SQUARE-OFF-BOARD AND SQUARE-VACANT ARE BOTH
; HIGHER NUMERICALLY THAN THE HIGHEST EXISTANT PIECE.
; OTHERWISE, BOARD HAS PC NUMBER OF PIECE ON SQUARE.
;  SQUARE NUMBERS ASCEND FROM QUEEN-SIDE TO KING-SIDE, AND FROM WHITE'S SIDE
; OF THE BOARD TO BLACK'S.

;PIECE NUMBER 
;  0-31. NAME THE 32. PIECES (16. WHITE, THEN 16. BLACK).
;   0-7 ARE THE WHITE PAWNS FROM QRP TO KRP
;  10-17 ARE THE WHITE PIECES, FROM QR TO KR (AS THEY ARE IN THE INITIAL POSITION).

;BASIC DATA ARRAYS PER SQUARE.

;WA, BA.  4 BIT BYTE ARRAY, NUMBER OF ATTACKS BY SIDE ON SQUARE.

(SPECIAL CHESS-PROPERTY-INDICATORS)
(SETQ CHESS-PROPERTY-INDICATORS '(MOVE-LIST HIS-MOVE-LIST STATIC-ANNOTATIONS 
     DYNAMIC-ANNOTATIONS CHEOPS-RESULTS HIS-CHEOPS-RESULTS C-SEARCH-STATUS 
     PIECE-POSTING GAME-STATE SQUARE-KEYS HIS-SQUARE-KEYS 
     C-POSITION-INFO C-PAWN-INFO MOVE-SUMMARY))

; C-CURRENT-POSITION HOLDS A GENSYM ASSOCIATED WITH THE CURRENT POSITION.
;FOR EACH POSITION EXAMINED, SUCH A GENSYM IS CREATED.  ITS PROPERTY LIST IS THE MAIN
;REPOSITORY FOR INFORMATION THAT IS OBTAINED ABOUT THE POSITION.  THE FOLLOWING
;PROPERTY INDICATORS ARE USED IN THIS CONTEXT:
; MOVE-LIST   VALUE IS AN ARRAY WHICH CONTAINS LIST OF SEMI-LEGAL MOVES FOR THE SIDE
;	       TO MOVE.  EACH MOVE TAKES
;	       C-MVL-NQS ENTRIES OF THE ARRAY, AND EACH ENTRY HAS A SYMBOLIC NAME
;	       PREFIXED WITH C-MVL- .
; HIS-MOVE-LIST  SIMILAR TO MOVE-LIST, FOR HIM ASSUMING IT WAS HIS TURN. IF MOVE
;              CAPTURES OUR K, C-MVL-STATE IS CAPTURES-KING.
; STATIC-ANNOTATIONS  SEE CANOTE.
; DYNAMIC-ANNOTATIONS   SEE CANOTE.
;--FLUSHED FOR THE MOST PART. IN CHEOPS-RESULTS-NOW--
;   MOVE-GROSS-POSITIONALITY  AN ARRAY WHICH CONTAINS 
;	      <POSITIONALITY OF MOVE> <MOVE-LIST-INDEX>.  IS SORTED ON POSITIONALITY.
;--OLD-- 
; CHEOPS-RESULTS NOW HAS JUST MOVE-INDEX.. OTHER INFO IN C-MVL- FROBS.
; CHEOPS-RESULTS AN ARRAY WHICH CONTAINS:  C-CH-NQS IS NUMBER OF ENTRIES BELOW
;		SORTED, WITH LOW NUMBERED ENTRIES BEST FOR SIDE-THAT-MOVED
;    C-CH-RESULT-VALUE    <CHEOPS-VALUE> 
;    C-CH-RESULT-DELTA    <CHEOPS-DELTA> 
;    C-CH-PV-LIST         <CHEOPS-PV-LIST> 
;    C-CH-SETD		  <CHEOPS-SETD>
;    C-CH-STAT		  <CHEOPS-STATISTICS-COUNTER (LOW 23 BITS>
;    C-CH-MOVE-IDX        <MOVE-LIST INDEX>
;    C-CH-MOVE-POSITIONALITY <POS>  MOVE POSITIONALITY.  HERE SO CAN BE USED AS LOW ORDER
;				    COMPONENT WHEN SORTING.
;  ARRAY-LEADER 0 IS FILL POINTER
;  ARRAY-LEADER 1 IS MOVE-LIST POINTER
; HIS-CHEOPS-RESULTS .. SIMILAR, BUT IF IT WERE HIS PLAY
; TATICAL-MOVE-POINTS  AN ARRAY WHICH CONTAINS:  C-TAT-NQS IS NUMBER OF ENTRIES BELOW
;    C-TAT-TOTAL          NUMERIC ESTIMATE OF TOTAL IMPORTANCE FOR SORTING
;    C-TAT-MOVE-IDX       MOVE-LIST INDEX
;    C-TAT-POINTS         A LIST, EACH ELEMENT OF WHICH IS A "POINT".
;			     CAR OF THE ELEMENT IS THE TYPE, SUCH AS ATTACKS, DEFENDS, ETC.
;   ARRAY-LEADER 0 IS FILL POINTER
;   ARRAY-LEADER 1 IS MOVE-LIST POINTER
; C-SEARCH-STATUS   CONTAINS A C-SEARCH-STATUS STRUCTURE, SEE BELOW.
; PIECE-POSTING   AN ARRAY GROUPPED BY PIECE-NUMBER.  FOR EACH PIECE
;		ITS C-GROUP-FUNCTION (CENTER-PAWN, HOME-PAWN, RANGER-PAWN, ETC)
;		ITS "STRENGTH"
;		WHAT ITS "DOING"
; GAME-STATE    CONTAINS CERTAIN SEMI-IRREVERSIBLE INFO ABOUT GENERAL PROGRESS OF GAME
;       SEE BELOW.
; SQUARE-KEYS   A BOARD-SIZE ARRAY.  EACH SQUARE ENTRY IS A LIST OF "KEYS" ASSOCIATED
;	WITH THAT SQUARE.  EACH KEY HAS ITS KEY-INDICATOR IN THE CAR, MOVE-INDEX IN CADR,
;      POSSIBLY FOLLOWED BY OTHER INFO SPECIFIC TO THE TYPE KEY.  POSSIBLE KEYS ARE:
;       (ATTACKS-SQUARE <MI> <OPTIONALLY  DISCOVERED>)
;       (HOLDS-ATTACK-ON-SQUARE <MI>)     ;MOVE MAINTAINS CURRENTLY EXISTING ATTACK ON SQ.
;       (MOVES-TO <MI>)
; HIS-SQUARE-KEYS 
; OCCUPIED-SQUARE-KEYS..
; C-POSITION-INFO  STORES ALGORITHMICALLY CALCULATED DATA WHICH, HOWEVER, IS PAINFUL TO
;      RECALCULATE
; C-PAWN-INFO    STORES INFO RELATING TO PAWN GROUPS, STRONG/WEAK PAWNS, PAWN-DESIGNATION
;	       	     (IE RANGER, HOME, ETC), AND PAWN-CENTER STATE
; MOVE-SUMMARY  INFO ABOUT VARIOUS MOVES THAT ALLEDGEDLY EXIST
; BASE-CHEOPS-RESULTS  RESULTS OF A SHORT CHEOPS SEARCH IN CURRENT POSITION W/EACH SIDE
;	TO MOVE.  
; c-active-keys  a list of active-key structures, the keys currently selected associated
;			with some useful associated data (see key hackery in kwc;lkpdef)

(DEFSTRUCT (MOVE-LIST :ARRAY-LEADER :NAMED (:SIZE-MACRO MOVE-LIST-ARRAY-LEADER-SIZE))
	MOVE-LIST-FILL-POINTER
	MOVE-LIST-COMPUTED-KEYS  ;LIST OF FROBS WHICH HAVE BEEN COMPUTED ON THIS MOVE-LIST
			         ;KWC is using this slot to keep the reason that moves
				 ;are selected so that it might be possible to do some threat
				 ;analysis, etc.  Also, it is a good exercise just to have
				 ;the system explain what it is trying to do.
	MOVE-LIST-SIDE		 ;SIDE THESE MOVES FOR.
)

(DEFSTRUCT (MOVE-SUMMARY :ARRAY :NAMED (:SIZE-MACRO MOVE-SUMMARY-ARRAY-SIZE))
	MOVE-SUMMARY-MOVE-LIST 
	MOVE-SUMMARY-DIRECT-GAIN-MOVES
	MOVE-SUMMARY-CHEOPS-DIRECT-GAIN-MOVES 
	MOVE-SUMMARY-DEFENDING-MOVES	;(SQUARE . <LIST OF MOVE-INDEXES>)
	MOVE-SUMMARY-ATTACKING-MOVES    ;  "
	MOVE-SUMMARY-TEMPO-ATTACKING-MOVES 
	MOVE-SUMMARY-DEVELOPING-MOVES 
	MOVE-SUMMARY-POSTING-MOVES
	MOVE-SUMMARY-SPECIALITY-MOVES
)

;HOLDS THE RESULTS OF A SHORT CHEOPS SEARCH IN THE CURRENT POSITION.  
(DEFSTRUCT (BASE-CHEOPS-RESULTS :ARRAY :NAMED (:SIZE-MACRO BASE-CHEOPS-RESULTS-ARRAY-SIZE))
	BASE-CHEOPS-RESULTS-CURRENT-MATERIAL	;IN CHEOPS UNITS.
	BASE-CHEOPS-RESULTS-VALUE 
	BASE-CHEOPS-RESULTS-DELTA 
	BASE-CHEOPS-RESULTS-PV-LIST 
	BASE-CHEOPS-RESULTS-VALUE-WHTM	  ;VALUE WITH HIM-TO-MOVE
	BASE-CHEOPS-RESULTS-PV-LIST-WHTM  ;PV WITH HIM-TO-MOVE
	BASE-CHEOPS-RESULTS-KEYS
)

(DEFSTRUCT (C-PAWN-INFO :ARRAY :NAMED (:SIZE-MACRO C-PAWN-INFO-ARRAY-SIZE))
       C-PAWN-INFO-WHITE-POSITION-KEYS 		;POSITION WISE IMPORTANT KEYS
       C-PAWN-INFO-BLACK-POSITION-KEYS 
       C-PAWN-INFO-WHITE-PAWN-GROUPS
       C-PAWN-INFO-BLACK-PAWN-GROUPS
       C-PAWN-INFO-WHITE-PAWN-IDENTIFICATION	;K-RANGER, Q-RANGER, OR NIL
       C-PAWN-INFO-BLACK-PAWN-IDENTIFICATION
       C-PAWN-INFO-PAWN-KEYS-ARRAY 
       C-PAWN-INFO-WHITE-PAWNS-ON-FILE-ARRAY
       C-PAWN-INFO-BLACK-PAWNS-ON-FILE-ARRAY 
       C-PAWN-INFO-FILE-KEYS-ARRAY
)
	   
(DEFSTRUCT (C-POSITION-INFO :ARRAY :NAMED (:SIZE-MACRO C-POSITION-INFO-ARRAY-SIZE))
       C-POS-POSITION-SYMBOL
       C-POS-SIDE		 ; SIDE TO MOVE.  USE THIS TO HELP STRAIGHEN OUT
				 ; HIS-OURS LOSSAGE IF NECESSARY.
       C-POS-MOVE-LIST
       C-POS-HIS-MOVE-LIST 
       C-POS-PIECE-DEVELOPMENT-ARRAY   ;FOR EACH PIECE, THE SUM OF THE SQUARE VALUES
       				       ; IT CURRENTLY HITS.  NOT WEIGHTED.
       C-POS-BEARS-ON-SQUARE     ; BEARS-ON-SQUARE IS A BOARD-SIZE ARRAY.  
				 ; EACH SQUARE ENTRY IS A LIST (PIECE <DIR> <MODE>) .
				 ;  <DIR> AND <MODE> MAY BE ABSENT IF NIL.
				 ; LIST IS IN SORTED ORDER LEAST VALUABLE PIECE FIRST,
       				 ; EXCEPT PIECE IN THRU MODE NOT MUST FOLLOW THE PIECE
				 ; THEY ARE THRU.
       C-POS-HIS-BEARS-ON-SQUARE ;LIKEWISE FOR HIS PIECES
       C-POS-OUR-PIECE-MATERIAL 
       C-POS-HIS-PIECE-MATERIAL
       C-POS-PIECE-MATERIAL-DIFFERENCE
       C-POS-OUR-PAWN-MATERIAL
       C-POS-HIS-PAWN-MATERIAL
       C-POS-PAWN-MATERIAL-DIFFERENCE
       C-POS-OUR-TOTAL-DEVELOPMENT
       C-POS-HIS-TOTAL-DEVELOPMENT
       C-POS-DEVELOPMENT-DIFFERENCE
       C-POS-SQUARE-CONTROL-ARRAY  ;IF NIL, NOT COMPUTED YET.
       C-POS-STOP-SQUARE-ARRAY	   ;IF NIL, NOT COMPUTED YET.
       C-POS-ATTACK-RELATIONS-ARRAY  ;IF NIL, NOT COMPUTED YET.
       C-POS-DEFENSE-RELATIONS-ARRAY ;IF NIL, NOT COMPUTED YET.
       C-POS-CAPTURE-SUMMARY	     ;IF NIL, NOT COMPUTED YET.
)

(DEFSTRUCT (C-GAME-STATE :ARRAY :NAMED (:SIZE-MACRO C-GAME-STATE-ARRAY-SIZE))
       C-GAME-STATE-GENERAL-PHASE	;OPENING, OPENING-MIDDLE-GAME, MIDDLE-GAME
					; ENDGAME <SPECIALIZED-ENDGAME>
       C-GAME-STATE-WHITE-CASTLING-HISTORY    ;NIL OR CASTLES-KING OR CASTLES-QUEEN IF EVER
					; CASTLED IN CURRENT GAME.
       C-GAME-STATE-BLACK-CASTLING-HISTORY    ;LIKEWISE FOR BLACK
;      C-GAME-STATE-WHITE-CASTLING 	;ONE OF NONE, CASTLED-KING, CASTLED-QUEEN,
;      C-GAME-STATE-BLACK-CASTLING      ;  EITHER, K-SIDE-ONLY, Q-SIDE-ONLY
;      C-GAME-STATE-WHITE-CASTLING-OPTIONS ;AS ABOVE, BUT CONSIDERING "BROKEN"
;      C-GAME-STATE-BLACK-CASTLING-OPTIONS ; PAWN STRUCTURE AS RULING OUT CASTLING
					   ; ON THAT SIDE.
       
)

(DEFSTRUCT (CAPTURE-SUMMARY :ARRAY :NAMED (:SIZE-MACRO CAPTURE-SUMMARY-ARRAY-SIZE))
       CAPTURE-SUMMARY-PIECE-EN-PRISE-STATUS 
  ;ELEMENTS OF THE FOLLOWING TWO LISTS ARE CAPTURE-LIST-ITEM STRUCTURES.
       CAPTURE-SUMMARY-OUR-CAN-BE-CAPT-LIST  ;OUR PCS THAT CAN BE..
       CAPTURE-SUMMARY-HIS-CAN-BE-CAPT-LIST  ; HIS..  SORTED LIST.
  ;ELEMENTS OF THE FOLLOWING FOUR LISTS ARE THREE-RELATION STRUCTURES.
       CAPTURE-SUMMARY-OUR-POSSIBLE-PINS     ;OUR PCS THAT MAY BE PINNED 
       CAPTURE-SUMMARY-HIS-POSSIBLE-PINS     ;  LIST OF THREE-RELATIONS.
       CAPTURE-SUMMARY-OUR-POSSIBLE-DISCOVERIES  ;OUR PCS THAT MAY MOVE, CREATING DISCOVERIES
       CAPTURE-SUMMARY-HIS-POSSIBLE-DISCOVERIES 
       CAPTURE-SUMMARY-3R-CENTER-INDEX-ARRAY  ;PIECE SIZE ARRAY.  FOR EACH PIECE, LIST OF
					      ; 3R'S OF WHICH IT IS THE CENTER MEMBER.
)

(DEFSTRUCT (CENTER-INDEX-ARRAY :ARRAY-LEADER :NAMED
		      (:SIZE-MACRO CENTER-INDEX-ARRAY-ARRAY-LEADER-SIZE))
      CENTER-INDEX-UNUSED
      CENTER-INDEX-WBOS      ;WHITE BEARS ON SQUARE ARRAY
      CENTER-INDEX-BBOS	     ;BLACK
)  ;ARRAY IS PIECE-SIZE; FOR EACH PIECE, LIST OF 3R'S OF WHICH IT IS THE CENTER MEMBER.

;THIS STRUCTURE USED BOTH FOR REPRESENTING CURRENTLY-POSSIBLE CAPTURES
; AND DIRECT GAINS OF MOVES.
(DEFSTRUCT (CAPTURE-LIST-ITEM :ARRAY :NAMED (:SIZE-MACRO CAPTURE-LIST-ITEM-ARRAY-SIZE))
       CAPTURE-LIST-ITEM-VALUE
       CAPTURE-LIST-ITEM-PLYN
       CAPTURE-LIST-ITEM-SQUARE 
       CAPTURE-LIST-ITEM-CAPTURED-PIECE
       CAPTURE-LIST-ITEM-ATTACKING-PIECE-LIST
       CAPTURE-LIST-ITEM-DEFENDING-PIECE-LIST
       CAPTURE-LIST-ITEM-BIAS      ;NIL -> NO "QUESTIONABLE" DECISIONS HAVE HAD TO BE
       CAPTURE-LIST-ITEM-KEYS	   ; MADE, ATTACK -> SOME DEFENDERS HAVE BEEN "ELIMINATED",
				   ; DEFENSE -> SOME ATTACKERS ETC.
)

; THREE-RELATION S ARE USED TO REPRESENT PINS AND DISCOVERIES.  THE CENTER SQUARE IS THE
;SQUARE OCCUPIED BY THE PIECE PINNED IN THE CASE OF A PIN, OR THE PIECE WHICH MOVES TO
;CREATE THE DISCOVERY.  THE BASE-SQUARE RECEIVES THE RESULTING ATTACK.
(DEFSTRUCT (THREE-RELATION :ARRAY :NAMED (:SIZE-MACRO THREE-RELATION-ARRAY-SIZE))
       THREE-RELATION-CENTER-SQUARE
       THREE-RELATION-ATTACK-DESCRIPTION
       THREE-RELATION-BASE-SQUARE
       THREE-RELATION-VALUE 		   ;NIL IF NOT COMPUTED.
       THREE-RELATION-UNMASKING-MOVES	   ;MOVES OF CENTER PIECE WHICH "ACTIVATE" THIS.
       THREE-RELATION-INDIRECT-MOVES	   ;MOVES WHOSE DIRECT GAIN COMPUTATION INFLUENCED
					   ; BY THIS.  IE CENTER PIECE ASSUMED PINNED, SO
					   ; THAT MOVE CAN CAPTURE SOMETHING THAT WOULD HAVE
					   ; BEEN DEFENDED, ETC.  EACH ELEMENT A LIST OF
					   ; (<MOVE-LIST> <MOVE-LIST-IDX>).
       THREE-RELATION-KEYS
)

(DEFSTRUCT (DEFENSE-RELATIONS :ARRAY-LEADER :NAMED
		   (:SIZE-MACRO DEFENSE-RELATIONS-ARRAY-LEADER-SIZE))
					    ;ARRAY IS PIECE-ARRAY SIZE.  FOR EACH PIECE
       DEFENSE-RELATIONS-UNUSED		    ; HAS KEYS ABOUT WHICH OF OUR PIECES WHICH
				            ; IS ATTACKED, THIS ONE DEFENDS, ETC.
)

(DEFSTRUCT (ATTACK-RELATIONS :ARRAY-LEADER :NAMED
		   (:SIZE-MACRO ATTACK-RELATIONS-ARRAY-LEADER-SIZE))
					    ;ARRAY IS PIECE-ARRAY SIZE.  FOR EACH PIECE,
	ATTACK-RELATIONS-UNUSED		    ; HAS KEYS ABOUT WHAT MOVES ATTACK OR DEFEND
)

(DEFSTRUCT (ATTACK-INSTANCE :ARRAY :NAMED (:SIZE-MACRO ATTACK-INSTANCE-ARRAY-SIZE))
	ATTACK-INSTANCE-VALUE 
	ATTACK-INSTANCE-SQUARE 
	ATTACK-INSTANCE-PIECE 
	ATTACK-INSTANCE-ATTACKING-PIECE-LIST  
	ATTACK-INSTANCE-DEFENDING-PIECE-LIST
	ATTACK-INSTANCE-KEYS
	ATTACK-INSTANCE-MOVE-IDX)    ;MOVE INDEX OF MOVE GIVING RISE TO THIS ATTACK

(DEFSTRUCT (C-SEARCH-STATUS :ARRAY-LEADER :NAMED
		  (:SIZE-MACRO C-SEARCH-STATUS-ARRAY-LEADER-SIZE))
       C-SEARCH-UNUSED		     ;FILL POINTER?
       C-SEARCH-POSITION	     ;POSITION ATOM
       C-SEARCH-SIDE		     ;0 WHITE, 1 BLACK
       C-SEARCH-SELECTOR-CLOSURE 
       C-SEARCH-ACTIVE-KEYS-ALIST    ;DUPLICATE OF C-ACTIVE-KEYS-ALIST FOR CONVIENCE OF
				     ; C-INVOKE-KEY-CLOSURE
       C-SEARCH-NEED-FOR-CUTOFF 
       C-SEARCH-NEED-TO-BE-INTERESTING 
       C-SEARCH-CHEOPS-ABOVE-CUTOFF	;NUMBER MVS PRELIMINARY CHEOPS SEARCH SAYS ...
       C-SEARCH-CHEOPS-ABOVE-INTERESTING ;NUMBER  "   ...
       C-SEARCH-CHEOPS-POS-DELTA	;NUMBER MVS WITH CHEOPS DELTA >0
       C-SEARCH-CHEOPS-NON-NEG-DELTA    ;NUMBER MVS WITH CHEOPS DELTA >= 0
       C-SEARCH-MOVE-TYPE		;POSITIONAL, AGGRESSIVE OR DEFENSIVE BASED ON ABOVE
					; PARAMETERS
       C-SEARCH-BSF			;MOVE-INDEX OF BSF MOVE OR NIL
       C-SEARCH-BSF-VALUE 		;C-MVL-SEARCH-VALUE (VALUE THAT ONE GOT)
       C-SEARCH-BSF-RESULTS		;C-MVL-SEARCH-RESULTS FOR THAT ONE
)

;MOVE-LIST ENTRIES
; C-MVL-MOVING-PC
; C-MVL-TO-SQ 
; C-MVL-DIRECTION (FOR SLIDING PCS)
; C-MVL-CODE      (CASTLES-KING, ETC, SEE LIST BELOW)
; C-MVL-MARKER    AVAILABLE FOR TEMPORARY HACKING/MARKING
; C-MVL-FOLLOWING-POSITION  NIL OR GENSYM FOR FOLLOWING POSITION (IF THIS MOVE HAS BEEN
;				PLAYED, ETC)
; C-MVL-STATE     NIL UNLESS MOVE HAS BEEN DEFINITLY CATEGORIZED. 
;		        ILLEGAL  -> MOVE A LOSER.
; C-MVL-SEARCH-CHEOPS-VALUE	NUMERIC VALUE OF CHEOPS SEARCH DONE AT
;				END ON P.V. SEARCHED, OR NIL IF NOT SEARCHED
; C-MVL-SEARCH-POSITIONAL-VALUE NUMERIC VALUE OF LCHESS POSITIONAL HACKER RETURNED
;				FROM SEARCH
; C-MVL-SEARCH-RESULTS  RESULTS OF SEARCHING THIS MOVE, OR NIL IF NOT LOOKED AT.
; C-MVL-SEARCH-KEYS-PASSED-DOWN KEYS THAT WERE PASSED TO LOWER PLY WHEN THIS SEARCH DONE.
; C-MVL-ASSOCIATED-KEYS LISTS OF KEY ROUTINES THAT HAVE ASSOCIATED THEMSELVES
;			WITH THIS MOVE
; C-MVL-MO-KEYS   AS GENERATED BY MO ROUTINES
; C-MVL-DIRECT-RESULTS    A LIST OF STRUCTURES WHICH GIVE DIRECT RESULTS OF THIS MOVE.
;     CAPTURE-LIST-ITEM -> CAN BE CAPTURED.
;	 NOTE THAT GAIN IS GAIN FOR HIM, SO A NEGATIVE VALUE IN GAIN
;	 MEANS IT LOOKS LIKE A GOOD MOVE FOR US.
;     THREE-RELATION -> (MEMQ 'PIN (THREE-RELATION-KEYS XX))
;	 		  PIECE IS PINNED.
;     		     -> (MEMQ 'DISCOVERY (THREE-RELATION-KEYS XX))
;			  MOVING PIECE CAUSES DISCOVERY ON HIM.
; C-MVL-CH-RESULT-VALUE
; C-MVL-CH-RESULT-DELTA
; C-MVL-CH-PV-LIST
; C-MVL-MOVE-POSITIONALITY
; C-MVL-ATTACK-INSTANCES 

; C-CURRENT-GAME-NAME HOLDS A GENSYM ASSOCIATED WITH THE CURRENT GAME (OR MAY BE NIL).
;THE FOLLOWING INDICATORS ARE USED ON THE PROPERTY LISTS OF SUCH GENSYMS:
; COMMENT     AN ARBITRARY COMMENT
; GAME-MOVES  LIST OF MOVES CONSITITUTING GAME.
;	       IF 1ST ELEMENT OF LIST IS 'MOVE, REST OF ELEMENT IS 
;		   MOVING-PC  TO-SQ  CODE

(SPECIAL PLYN BOARD-SIZE BOARD-WIDTH PIECE-ARRAY-SIZE)

(SPECIAL PIECE-ARRAY BOARD-ARRAY GAME-ARRAY POSITION-HASH-ARRAY)
   ;BOARD-PAWN-DATA-ARRAY
   ;ALL OTHER DATA STRUCTURES ARE HUNG OFF ONE OF PIECE-ARRAY, BOARD-ARRAY, GAME-ARRAY,
   ; OR BOARD-PAWN-DATA-ARRAY SO LAMBDA BINDING THEM IS SUFFICIENT TO SAVE THE 
   ; WHOLE DATA STATE.  ALSO, THE VARIABLE C-CURRENT-POSITION NEEDS TO BE SAVED.
   ;IF NEW VARIABLES OR ARRAYS IN THE CLASS ARE ADDED, CODE MUST BE MODIFIED AT
   ; THE FOLLOWING PLACES:
      ;C-ALLOCATE-SCRATCH-BOARD-STRUCTURES C-ALLOCATE-BOARD-STRUCTURES 
      ;C-PRINT-GAME C-WRITE-GAME C-READ-GAME 
   ;POSITION-HASH-ARRAY ALSO HAS GLOBAL DATA, BUT USUALLY IT IS DESIRABLE TO LET IT
   ; CARRY OVER.
(SPECIAL SCRATCH-PIECE-ARRAY SCRATCH-BOARD-ARRAY SCRATCH-GAME-ARRAY)
	 ;SCRATCH-BOARD-PAWN-DATA-ARRAY ;THESE HOLD STORAGE
		;ALLOCATED TO BIND TO ABOVE FOR SCRATCH USE.
(SPECIAL C-MAIN-PIECE-ARRAY C-MAIN-BOARD-ARRAY C-MAIN-GAME-ARRAY)
	 ;C-MAIN-BOARD-PAWN-DATA-ARRAY

(SPECIAL SQUARE-OFF-BOARD SQUARE-VACANT)

(SPECIAL WHITE-AT-TOP-P)

(SPECIAL SYMBOLIC-WOOD-TYPES INITIAL-TYPE-WOOD-VALUE-ARRAY TYPE-WOOD-LETTER 
	 INITIAL-TYPE-WOOD-POSITIONAL-FACTOR-ARRAY TYPE-WOOD-CHEOPS-VALUE-ARRAY)

(special king-material-value
	 queen-material-value
	 rook-material-value
	 bishop-material-value
	 knight-material-value
	 pawn-material-value)
	
(SPECIAL CHEOPS-MATERIAL-VALUE-FACTOR)
(SETQ CHEOPS-MATERIAL-VALUE-FACTOR (// #o200 #o10))  ;MULTIPLY CHEOPS VALUES BY THIS
						 ; TO GET CORRESPONDING LCHESS VALUES

(SPECIAL C-BOARD-SQUARE-NUMBER C-FILE-NAMES C-HASH-SQUARE C-PIECE-INITIAL-SQUARE 
	 C-BOARD-WHITE-RANK-NUMBER C-BOARD-FILE-NUMBER C-BOARD-POS-DIAG-NUMBER
	 C-BOARD-NEG-DIAG-NUMBER)

(SPECIAL C-SQUARE-PIECE-ATTACKS-ARRAY  ;FOR EACH SQ, A 32 BIT ARRAY.  BIT IS SET IF CORRESP
	 			       ; PC CURRENTLY ATTS THAT SQ.
	 C-SQUARE-SIDE-ATTACKS-ARRAY)  ;FOR EACH SQ, AN INDIRECT ARRAY POINTER TO ABOVE ARRAY,
				       ; BUT WITH ART-16B, SO AS TO ACCESS 16 BITS CORRESP.
				       ; TO A SIDE AS ONE ENTRY.
(SPECIAL C-PIECE-IDENTIFICATION-ARRAY C-PIECE-TEXT-ARRAY 
	 C-SQUARE-IDENTIFICATION-ARRAY 
	 C-SQUARE-CENTRALITY-FACTOR-ARRAY C-RANK-FILE-TO-SQUARE-MAP)

(SPECIAL WQR1 WQR2 wkr1 wqr8 WQR5 BQR1 bkr1 BQR2 BKR5 WKR8 BKR4 WQR4 BQR4 
	 WKR4 WK5 WQ5 WK4 WQ4 
	 WQN1 WQB1 WK1 WKN1 wkb1 BQN1 BQB1 BK1 BKN1)		;ALL OTHERS EXIST TOO.

(SPECIAL WQRP WQNP WQBP WQP WKP WKBP WKNP WKRP WQR WQN WQB WQ WK WKB WKN WKR 
	 BQRP BQNP BQBP BQP BKP BKBP BKNP BKRP BQR BQN BQB BQ BK BKB BKN BKR)

(SPECIAL CURRENT-SIDE CURRENT-PIECE CURRENT-LOCATION)

(SPECIAL C-CURRENT-POSITION C-MOVE-LIST C-CURRENT-GAME-NAME C-ANNOTATER 
	 C-BEARS-ON-SQUARE 
	 CHEOPS-BACKGROUND-RING-POSITION CHEOPS-BACKGROUND-MOVE-LIST 
	 CHEOPS-BACKGROUND-RESULTS-ARRAY)

(SPECIAL STATIC-ANNOTATION-OPS DYNAMIC-ANNOTATION-OPS 
	 STATIC-EVALUATIVE-COMMENTS DYNAMIC-EVALUATIVE-COMMENTS)

(SPECIAL SPECIAL-IMP-ARRAY SPECIAL-ACCUM-POS)

(SPECIAL C-MVL-QS C-MVL-NQS 
	C-MVL-MOVING-PC C-MVL-TO-SQ C-MVL-DIRECTION C-MVL-CODE C-MVL-MARKER 
	C-MVL-FOLLOWING-POSITION C-MVL-STATE C-MVL-SEARCH-CHEOPS-VALUE 
	C-MVL-SEARCH-POSITIONAL-VALUE C-MVL-SEARCH-RESULTS C-MVL-SEARCH-KEYS-PASSED-DOWN 
	C-MVL-ASSOCIATED-KEYS C-MVL-MO-KEYS C-MVL-DIRECT-RESULTS 
	C-MVL-CH-RESULT-VALUE C-MVL-CH-RESULT-DELTA C-MVL-CH-PV-LIST
	C-MVL-MOVE-POSITIONALITY C-MVL-ATTACK-INSTANCES c-mvl-rejected)

(SETQ C-MVL-QS '(C-MVL-MOVING-PC C-MVL-TO-SQ C-MVL-DIRECTION C-MVL-CODE C-MVL-MARKER 
	C-MVL-FOLLOWING-POSITION C-MVL-STATE C-MVL-SEARCH-CHEOPS-VALUE 
	C-MVL-SEARCH-POSITIONAL-VALUE C-MVL-SEARCH-RESULTS C-MVL-SEARCH-KEYS-PASSED-DOWN 
	C-MVL-ASSOCIATED-KEYS C-MVL-MO-KEYS C-MVL-DIRECT-RESULTS
	C-MVL-CH-RESULT-VALUE C-MVL-CH-RESULT-DELTA C-MVL-CH-PV-LIST
	C-MVL-MOVE-POSITIONALITY C-MVL-ATTACK-INSTANCES c-mvl-rejected))
    ;IF ANY ADDED, UPDATE C-STORE-SEMI-LEGAL-MOVE
(SETQ C-MVL-NQS (LENGTH C-MVL-QS))
(IF-IN-LISPM (ASSIGN-POSITION-IN-LIST C-MVL-QS))

;(SPECIAL C-CH-QS C-CH-NQS C-CH-RESULT-VALUE C-CH-RESULT-DELTA C-CH-PV-LIST 
;	 C-CH-SETD C-CH-STAT C-CH-MOVE-IDX C-CH-MOVE-POSITIONALITY)
(SPECIAL C-CH-QS C-CH-NQS C-CH-MOVE-IDX)

;(SETQ C-CH-QS '(C-CH-RESULT-VALUE C-CH-RESULT-DELTA C-CH-PV-LIST 
;     C-CH-SETD C-CH-STAT C-CH-MOVE-IDX C-CH-MOVE-POSITIONALITY))
(SETQ C-CH-QS '(C-CH-MOVE-IDX))
     ;IF ANY ADDED, UPDATE CHEOPS-RETURN-RESULTS-ARRAY. 
(SETQ C-CH-NQS (LENGTH C-CH-QS))
(IF-IN-LISPM (ASSIGN-POSITION-IN-LIST C-CH-QS))

(SPECIAL C-TAT-QS C-TAT-NQS C-TAT-TOTAL C-TAT-MOVE-IDX C-TAT-POINTS)

(SETQ C-TAT-QS '(C-TAT-TOTAL C-TAT-MOVE-IDX C-TAT-POINTS))
     ;IF ANY ADDED, UPDATE C-COMPUTE-TATICAL-POINTS
(SETQ C-TAT-NQS (LENGTH C-TAT-QS))
(IF-IN-LISPM (ASSIGN-POSITION-IN-LIST C-TAT-QS))

(SPECIAL C-GAME-QS C-GAME-NQS C-GAME-DEFAULT-LENGTH 
	C-GAME-MOVING-PC C-GAME-FROM-SQ C-GAME-CAPT-PC C-GAME-TO-SQ 
	C-GAME-GHOST-LOCATION C-GAME-CODE C-GAME-CURRENT-POSITION )

(SETQ C-GAME-DEFAULT-LENGTH 150.)   ;DEFAULT LENGTH WHEN CREATING GAME-ARRAYS (IN PLIES)

(SETQ C-GAME-QS '(
	C-GAME-MOVING-PC C-GAME-FROM-SQ C-GAME-CAPT-PC C-GAME-TO-SQ 
	C-GAME-GHOST-LOCATION C-GAME-CODE C-GAME-CURRENT-POSITION ))
   ;IF ANY ADDED, UPDATE C-PLAY-MOVE, C-REVERT-MOVE
(SETQ C-GAME-NQS (LENGTH C-GAME-QS))
(IF-IN-LISPM (ASSIGN-POSITION-IN-LIST C-GAME-QS))

(SPECIAL C-CODE-VALUES)
;LEGIMATE VALUES FOR C-GAME-CODE OR C-MVL-CODE.  IF ANY ADDED, UPDATE CODE AT
;  C-PLAY-MOVE, C-REVERT-MOVE, C-STORE-SEMI-LEGAL-MOVE, C-INPUT-SCAN.
;IN ADDITION, CHECK C-FIND-MOVE-IN-MOVE-LIST.
(SETQ C-CODE-VALUES '(CASTLES-KING CASTLES-QUEEN EN-PASSENT))

(SPECIAL BOARD-WIDTH*2 BOARD-WIDTH*3 BOARD-WIDTH*8 BOARD-WIDTH*10 BOARD-WIDTH*16
	 BOARD-WIDTH*32 BOARD-WIDTH*64 BOARD-WIDTH*128)

(SPECIAL C-A-DISPATCH C-M-DISPATCH C-CAT-DISPATCH C-POST-DISPATCH 
	 C-MO-DISPATCH)

(SPECIAL C-BOARD-INC-IN-DIR C-DIRECTION-NAMES)

(SPECIAL C200-200)	;16 BIT CONSTANT, 200 IN EACH 8 BIT BYTE

(SPECIAL CONSOLE-IO-PC-PPR CHESS-CONSOLE-IO-PC-PPR CHESS-BOARD-PC-PPR)

(SPECIAL C-LAST-INPUT)	;LAST INPUT READ BY C-EVAL-SEXP-FROM-FILE

(SPECIAL C-MAP-TO-CHEOPS-SQUARE C-MAP-TO-LISPM-SQUARE 
	 C-MAP-TO-CHEOPS-PIECE C-MAP-TO-LISPM-PIECE)

(SPECIAL SQUARE-BEARS-AREA CHESS-TEMPORARY-AREA)

;SPECIALS IN THIS GROUP ASSOCIATED WITH C-COMPUTE-SQUARE-KEYS, ETC
(SPECIAL SPECIAL-BOARD-KEYS-ARRAY SPECIAL-MOVE-INDEX)

;SPECIALS IN THIS GROUP ASSOCIATED WITH C-KEY- ROUTINES
(SPECIAL C-SELECT-BEST-BID C-SELECT-BEST-BIDDER 
	 C-ALL-KEYS-LIST C-ACTIVE-KEYS-ALIST 
	 C-KEY-SEARCH-STATUS C-KEY-CHEOPS-RESULTS C-KEY-CHEOPS-SELECT-INDEX 
	 C-KEY-CHEOPS-HISTOGRAM C-KEY-CHEOPS-MOVE-LIST C-KEY-CHEOPS-MOVE-INDEX 
	 SELF)

(DEFSTRUCT (BOARD-ARRAY :ARRAY-LEADER :NAMED
		 (:SIZE-MACRO BOARD-ARRAY-ARRAY-LEADER-SIZE))
	BOARD-UNUSED			;FILL-POINTER
	BOARD-GHOST-LOCATION 	        ;OR 0 IF GHOST DOESNT EXIST.
	BOARD-TYPE-WOOD-VALUE-ARRAY     ;FOR EACH TYPE-WOOD, ITS GROSS MATERIAL VALUE
					; ON THIS BOARD.  IF DESIRED TO CHANGE,
				        ; COPY ARRAY CONTENTS.
	BOARD-WHITE-CASTLED-PLY 	;PLY # AT WHICH WHITE CASTLED OR NIL
	BOARD-BLACK-CASTLED-PLY 	; THESE FROBS HERE FOR STATIC EVALUATOR CONV.
	BOARD-WHITE-CASTLED-K 		;T IF WHITE CASTLED Q-SIDE
	BOARD-BLACK-CASTLED-K 
	BOARD-WHITE-ATTACKS-ARRAY 	;FOR EACH SQ, NUMBER OF TIMES WHITE ATTS IT
	BOARD-BLACK-ATTACKS-ARRAY	; LIKEWISE BLACK
	BOARD-HASH 			;CURRENT HASH FOR HASH TABLE LOOKUP
	BOARD-CAT-DATA-VALID		;T IF CAT DATA COMPUTED FOR CURRENT POSITION
	BOARD-WHITE-IMPORTANCE-ARRAY	;FOR EACH SQ, ESTIMATED IMPORTANCE FOR 
	BOARD-BLACK-IMPORTANCE-ARRAY	; SIDE TO ATTACK IT
)

(DEFSTRUCT (PIECE-ARRAY :ARRAY-LEADER :NAMED (:SIZE-MACRO PIECE-ARRAY-ARRAY-LEADER-SIZE))
				 	;FOR EACH PIECE ITS LOCATION (OR ZERO -> NON-EXISTANT)
	PIECE-UNUSED			;FILL-POINTER?
	PIECE-WHITE-MAT-PAWNS 		;TOTAL MATERIAL VALUE OF ALL WHITE PAWNS
	PIECE-BLACK-MAT-PAWNS 		; LIKEWISE BLACK
	PIECE-WHITE-MAT-PCS 		;TOTAL MATERIAL VALUE OF ALL WHITE PCS
	PIECE-BLACK-MAT-PCS 		; LIKEWISE BLACK
	PIECE-TYPE-WOOD-ARRAY		;FOR EACH PC, SYMBOLIC TYPE WOOD, KING, QUEEN, ETC
	PIECE-TYPE-WOOD-NUMBER-ARRAY 	;FOR EACH PC, NUMBERIC TYPE WOOD CODE.
					; K Q B N R WP BP.
	PIECE-TYPE-WOOD-FLAVOR-ARRAY	;LIKE TYPE WOOD FLAVOR ARRAY, BUT SIDE COUNTS. IE
					; WHITE K IS DIFFERENT FROM BLACK K. USE THIS TO
					; ROTATE BY WHEN COMPUTING HASH.
;	PIECE-TYPE-WOOD-LETTER-ARRAY	;K Q B N R P
	PIECE-VALUE-ARRAY		;VALUE OF PC
	PIECE-NMOVES-ARRAY 		;FOR EACH PC, NUMBER TIMES IT HAS MOVED
	PIECE-DEVELOPMENT-VALUE-ARRAY	;FOR EACH PC, ITS CURRENT GENERAL DEVELOPMENT VALUE
					; (IE SUM OF IMPORTANCE OF ALL SQUARES IT HITS).
;	PIECE-PAWN-DATA-ARRAY		;FOR EACH PC WHICH IS A PAWN, ITS PAWN-DATA-ARRAY.
;	PIECE-KEY-SQUARES-ARRAY		;FOR EACH PC, AN ART-Q-LIST ARRAY W/ FILL POINTER.
					; EA TIME A PIECE IS INVOLVED IN A SQUARE CONTROL
					; DECISION FOR A SQUARE, THAT SQUARE NUMBER IS
					; ARRAY-PUSH ED INTO THE PIECES'S 
					; PIECE-KEY-SQUARES-ARRAY.  IF THE ARRAY OVERFLOWS,
					; THE WARNING FLAG IS SET FOR THE SQUARE.
	PIECE-POSITIONAL-WEIGHTING-FACTOR-ARRAY ;FOR EACH PC, A FACTOR TO MULTIPLY BY
					; THE VALUE OF A SQUARE IT ATTACKS TO GE T THE
					; DEVELOPMENT VALUE.  THIS VALUE IS GENERALLY
					; INVERSLY PROPORTIONAL TO THE VALUE OF THE PIECE.
					; THE IDEA IS TO GET SOMETHING COMPARABLE FOR
					; QUEENS VS PAWNS, ETC.
)

;THIS STUFF IS ALLOCATED AND INITIALIZED, BUT NONE OF IT IS CURRENTLY FILLED IN.
;(DEFSTRUCT (PAWN-DATA-ARRAY :ARRAY :NAMED  (:SIZE-MACRO PAWN-DATA-ARRAY-ARRAY-SIZE))
;	PAWN-DATA-STATUS	;DEF-BY-PAWN, NORMAL, ISOLATED, BACKWARD, FORWARD
;	PAWN-DATA-PASSED 
;	PAWN-DATA-HALF-FREE-FLAG 
;	PAWN-DATA-CANDIDATE 
;	PAWN-DATA-HELPER	;8 BITS, BIT SET IF P IS HELPER TO THIS ONE
;	PAWN-DATA-BLOCKER	;8 BITS, BIT SET IF HIS P IS BLOCKER TO THIS ONE.
;	PAWN-DATA-GUARD		;8 BITS, BIT SET IF HIS P IS GUARD TO THIS ONE.
;	PAWN-DATA-TYPE		;HOME CENTER OR RANGER
;	PAWN-DATA-REAR-TWIN
;;	PAWN-DATA-GROUP-ARRAY	;GROUP DATA BLOCK FOR GROUP THIS P BELONGS TO.
;)

;PAWN GROUPS ARE SEPARATED BY OPEN FILES FOR THE SIDE OF THE GROUP.  THUS,
; ONE GROUP MAY BE OPPOSED BY TWO GROUPS, ETC ETC.
(DEFSTRUCT (PAWN-GROUP :ARRAY :NAMED (:SIZE-MACRO PAWN-GROUP-ARRAY-SIZE))
	   PAWN-GROUP-LOW-FILE
	   PAWN-GROUP-HIGH-FILE 
	   PAWN-GROUP-MEMBERS	;A LIST OF SQUARES MEMBERS ARE ON, SORTED HEAD-PAWN FIRST
	   PAWN-GROUP-OPPOSING-PAWN-GROUPS   ;LIST OF OPPOSING PAWN-GROUPS WHOSE RANGES
					     ; PARTIALLY OVERLAP
	   PAWN-GROUP-KEYS
	   PAWN-GROUP-LOW-HEAD-DUO-STATE     ;ON POSSIBILITY OF HEAD DUO TO KING SIDE
	   PAWN-GROUP-HIGH-HEAD-DUO-STATE    ; TO Q SIDE
)

;;PAWN GROUPS ARE SEPARATED BY OPEN FILES FOR THE SIDE OF THE GROUP.  THUS,
;; ONE GROUP MAY BE OPPOSED BY TWO GROUPS, ETC ETC.
;(DEFSTRUCT (PAWN-GROUP-ARRAY :ARRAY :NAMED (:SIZE-MACRO PAWN-GROUP-ARRAY-ARRAY-SIZE))
;	PAWN-GROUP-STATUS 
;	PAWN-GROUP-MEMBERS	;8 BITS, BIT SET IF P MEMBER OF THIS GROUP.
;	PAWN-GROUP-OPPOSING-GROUPS 
;	PAWN-GROUP-CRIPPLED	;CONTAINS DOUBLED PAWN		
;	PAWN-GROUP-MAJORITY	;MORE PAWNS IN THIS GROUP THAN IN ALL OPPOSING GROUPS COMBINED.
;	PAWN-GROUP-MOBILITY
;	PAWN-GROUP-PASSERS	;8 BITS, BIT SET IF P IS PASSER
;	PAWN-GROUP-CANDIDATES	;8 BITS, BIT SET IF P IS CANDIDATE
;	PAWN-GROUP-HALF-FREES 	;8 BITS, BIT SET IF P IS HALF-FREE
;	PAWN-GROUP-CAN-MAKE-PASSER-FLAG
;)

(DEFSTRUCT (KING-SAFETY-ARRAY :ARRAY-LEADER :NAMED
		 (:SIZE-MACRO KING-SAFETY-ARRAY-ARRAY-LEADER-SIZE))
	KING-SAFETY-UNUSED
	KING-SAFETY-CASTLE-STATUS   ;UNCOMMITTED, CASTLED-K, CASTLED-Q, OPEN
	KING-SAFETY-MODE 	    ;UNCOMMITTED, CASTLED-K, WEAKENED-CASTLED-K,
				    ; OPEN-CASTLED-K, CASTLED-Q, ETC.
	KING-SAFETY-DEFENDERS 
	KING-SAFETY-ATTACKERS
	KING-SAFETY-HOME-PAWN-GROUP 
	KING-SAFETY-ATTACKING-PAWN-GROUP 
	KING-SAFETY-LUFT-NEEDED     ;BACK-RANK MATE POSSIBLE
	KING-SAFETY-CONFINED-TO-EDGE	;IF K AT EDGE AND NEIGHBORING 7TH RANK (ETC)
				    ; SQUARES ATTACKED BY OPPOSITION
)

(DEFSTRUCT (MOVE-OPINION-ARRAY :ARRAY :NAMED (:SIZE-MACRO MOVE-OPINION-ARRAY-ARRAY-SIZE))
	MOVE-OPINION-MOVE 
	MOVE-OPINION-NATURE	;DEVELOPING-MOVE, RETREATING-MOVE, ATTACKING-MOVE,
				; DEFENDING-MOVE.
	MOVE-OPINION-NATURALNESS 
	MOVE-OPINION-SHARPNESS 
	MOVE-OPINION-POSITIONALNESS 
	MOVE-OPINION-THREATS 
	MOVE-OPINION-THREATS-ANSWERED
	MOVE-OPINION-THREATS-COUNTERED
	MOVE-OPINION-DRAWBACKS 
	MOVE-OPINION-PREMATURE 
	MOVE-OPINION-PREPARATION 
	MOVE-OPINION-PREVENTION 
	MOVE-OPINION-HARASSING 
	MOVE-OPINION-TEMPO-MOVE 
	MOVE-OPINION-CLEAR-WASTE-OF-TIME 
)

(DEFSTRUCT (PAWN-BREAK-ARRAY :ARRAY :NAMED (:SIZE-MACRO PAWN-BREAK-ARRAY-ARRAY-SIZE))
	PAWN-BREAK-SQUARE 
	PAWN-BREAK-RESULT-IF-TAKES 
	PAWN-BREAK-RESULT-IF-IGNORES-AND-WE-PUSH-PAST 
	PAWN-BREAK-RESULT-IF-IGNORES-AND-WE-TAKE 
)

(DEFSTRUCT (PIN-DATA-ARRAY :ARRAY :NAMED (:SIZE-MACRO PIN-DATA-ARRAY-ARRAY-SIZE))
	PIN-DATA-PINNING-PIECE 
	PIN-DATA-PINNED-PIECE 
	PIN-DATA-BASE-PIECE 
	PIN-DATA-ON-WEAK-SQUARE 
	PIN-DATA-POTENTIAL-ATTACKERS
)

(DEFSTRUCT (CONSTRAINT-DATA-ARRAY :ARRAY :NAMED (:SIZE-MACRO CONSTRAINT-DATA-ARRAY-ARRAY-SIZE))
	CONSTRAINT-DATA-PIECE-CONSTRAINED 
	CONSTRAINT-DATA-SQUARE-CONSTRAINED-TO
)

(DEFSTRUCT (BACK-RANK-CONSTRAINT-ARRAY
	      :ARRAY :NAMED (:SIZE-MACRO BACK-RANK-CONSTRAINT-ARRAY-ARRAY-SIZE))
	BACK-RANK-PIECE-CONSTRAINED 
)

(DEFSTRUCT (GAME-OPINION-ARRAY :ARRAY :NAMED (:SIZE-MACRO GAME-OPINION-ARRAY-ARRAY-SIZE))
	GAME-OPINION-STATUS	;WHITE-WON, WHITE-WINNING, WHITE-CLEAR-ADVANTAGE,
				; WHITE-SLIGHT-ADVANTAGE, EVEN, CLEARLY-DRAWN, ETC
	GAME-OPINION-POSITION-TYPE	;CLOSED OPEN HALF-OPEN
	GAME-OPINION-WHITE-RELATIVE-ADVANTAGES 
	GAME-OPINION-BLACK-RELATIVE-ADVANTAGES 
	GAME-OPINION-TRADE-OF-QUEENS-FAVORS	;
	GAME-OPINION-TRADE-OF-PIECES-FAVORS	;STRONGLY-FAVORS-WHITE, FAVORS-WHITE, 
					; SLIGHTLY-DESIRED-BY-WHITE, EVEN
	GAME-OPINION-TRADE-OF-PAWNS-FAVORS 
	GAME-OPINION-WHITE-DEVELOPMENT 
	GAME-OPINION-BLACK-DEVELOPMENT 
	GAME-OPINION-OPENING-OF-GAME-FAVORS 
	GAME-OPINION-WHITE-PLAN 
	GAME-OPINION-BLACK-PLAN
)
;SEMANTIC MEMORY
;	MOVE-TO-FORWARD-SQUARE  CHASED-OFF-BY  RESULT
;	PIN OF PC BY PC ON SQUARE   STATUS
;	THREATNING-MOVE PIECE TO-SQUARE THREAT

;SEQUENCING STATE
;ALL PCS DEVELOPED

(DEFSTRUCT (GAME-ARRAY :ARRAY-LEADER :NAMED (:SIZE-MACRO GAME-ARRAY-ARRAY-LEADER-SIZE))
	GAME-FILL-POINTER
	GAME-PLY-NUMBER 		;NORMALLY SAME AS GAME-FILL-POINTER/8
)

(DEFSTRUCT (CHEOPS-RESULTS :ARRAY-LEADER :NAMED (:SIZE-MACRO CHEOPS-RESULTS-ARRAY-LEADER-SIZE))
        CHEOPS-RESULTS-FILL-POINTER 
	CHEOPS-RESULTS-MOVE-LIST-POINTER 
)

(DEFSTRUCT (BEARS-ON-SQUARE :ARRAY-LEADER :NAMED
		 (:SIZE-MACRO BEARS-ON-SQUARE-ARRAY-LEADER-SIZE))
        BEARS-ON-SQUARE-FILL-POINTER 
)

(DEFSTRUCT (SQUARE-CONTROL :ARRAY-LEADER :NAMED
		 (:SIZE-MACRO SQUARE-CONTROL-ARRAY-LEADER-SIZE))
	SQUARE-CONTROL-FILL-POINTER
)

(DEFSTRUCT (STOP-SQUARE :ARRAY-LEADER :NAMED (:SIZE-MACRO STOP-SQUARE-ARRAY-LEADER-SIZE))
	STOP-SQUARE-FILL-POINTER
)

(DEFSTRUCT (PAWN-KEYS :ARRAY-LEADER :NAMED (:SIZE-MACRO PAWN-KEYS-ARRAY-LEADER-SIZE))
	PAWN-KEYS-FILL-POINTER
)

(DEFSTRUCT (FILE-KEYS :ARRAY-LEADER :NAMED (:SIZE-MACRO FILE-KEYS-ARRAY-LEADER-SIZE))
        FILE-KEYS-FILL-POINTER
)
;THIS STUFF INVALID..  STORED DIRECTLY OFF BOARD-ARRAY NOW
;(DEFSTRUCT SQUARE-CONTROL-ARRAY :ARRAY-LEADER :NAMED
;;SQUARE CONTROL STUFF COMES IN SEVERAL FLAVORS:
;;  A- THAT WHICH IS TACTICAL AND MUST BE RECOMPUTED EVERY TIME ANY PIECE 
;;	WHICH BEARS ON SQUARE IS CHANGED
;;  B- PAWN-RELATED, WHICH IS AFFECTED ONLY BY PAWNS IN 8 NEIGHBORHOOD OF SQUARE.
;;  C- WHITE-KING-RELATED.  AFFECTED WHEN WHITE-KING MOVES.
;;  D- BLACK-KING-RELATED.
;	SQUARE-CONTROL-TACTICS-VALID 
;	SQUARE-CONTROL-PAWN-RELS-VALID 
;	SQUARE-CONTROL-WHITE-IMPORTANCE  ;ESTIMATED IMPORTANCE FOR WHITE TO ATTACK THIS
;					 ; SQUARE.
;	SQUARE-CONTROL-BLACK-IMPORTANCE  ;LIKEWISE BLACK.
;	SQUARE-CONTROL-TACTICAL-STATUS	;WHITE-STRONG-CONTROL, ETC
;	SQUARE-CONTROL-CONTROLLING-PC-NUMBER
;	SQUARE-CONTROL-WHITE-SWAPOUT-LIST 	;ACTUALLY AN ART-Q-LIST ARRAY.  HOLDS ALL PCS
;		;FOR THIS SIDE FROM BDA ARRAY ENTRY FOR THIS SQUARE, PLUS OUR SLIDING
;		;GUYS LINED UP BEHIND THEM.  IF HIS SLIDING GUY IS LINED UP BEHIND
;		;OURS, IGNORE THAT BUT SET UNCLEAR FLAG FOR PIECE.
;	SQUARE-CONTROL-WHITE-UNCLEAR-FLAG	;A PC HAS BEEN INCLUDED IN WHITE-SWAPOUT LIST
;					; WHICH MAY ACTUALLY BE CONSTRAINED OR PINNED,ETC
;	SQUARE-CONTROL-BLACK-SWAPOUT-LIST 
;	SQUARE-CONTROL-BLACK-UNCLEAR-FLAG
;
;;RAM SQUARE, WHITE-BREAK, BLACK-BREAK, WHITE-PAWN-CAN-MOVIN, BLACK-PAWN-CAN-MOVIN,
;;  WHITE-PAWN-ATTS, BLACK-PAWN-ATTS, WHITE-PAWN-ATTS-IN-ONE, BLACK-PAWN-ATTS-IN-ONE.
;
;)

(DEFMACRO CLOSED-FUNCTIONAL (FREE-CLOSED-VARIABLES CLOSED-VARIABLES INITIALIZING-MESSAGE EXP)
  `(PROG (SELF . ,CLOSED-VARIABLES)
	 (SETQ SELF (CLOSURE '(SELF ,@ FREE-CLOSED-VARIABLES . ,CLOSED-VARIABLES)
			      ,EXP))
	 ,@(COND (INITIALIZING-MESSAGE 
		  `((FUNCALL SELF . ,INITIALIZING-MESSAGE))))
	 (RETURN SELF)))
