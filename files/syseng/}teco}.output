
DSK  SYSENG	FOO   	02:01:16	FRIDAY  MARCH 09,1973	NM+5D.0H.35M.43S.



   IIIIIIIII         TTTTTTTTTTTTTTT         SSSSSSSSS      
   IIIIIIIII         TTTTTTTTTTTTTTT         SSSSSSSSS      
   IIIIIIIII         TTTTTTTTTTTTTTT         SSSSSSSSS      
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS               
      III                  TTT            SSS               
      III                  TTT            SSS               
      III                  TTT               SSSSSSSSS      
      III                  TTT               SSSSSSSSS      
      III                  TTT               SSSSSSSSS      
      III                  TTT                        SSS   
      III                  TTT                        SSS   
      III                  TTT                        SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
   IIIIIIIII               TTT               SSSSSSSSS      
   IIIIIIIII               TTT               SSSSSSSSS      
   IIIIIIIII               TTT               SSSSSSSSS      

DSK  SYSENG	FOO   	02:01:16	FRIDAY  MARCH 09,1973	NM+5D.0H.35M.43S.



777777777777777         888888888         555555555555555   
777777777777777         888888888         555555555555555   
777777777777777         888888888         555555555555555   
            777      888         888      555               
            777      888         888      555               
            777      888         888      555               
         777            888888888         555555555555      
         777            888888888         555555555555      
         777            888888888         555555555555      
      777            888         888                  555   
      777            888         888                  555   
      777            888         888                  555   
   777               888         888                  555   
   777               888         888                  555   
   777               888         888                  555   
777                  888         888      555         555   
777                  888         888      555         555   
777                  888         888      555         555   
777                     888888888            555555555      
777                     888888888            555555555      
777                     888888888            555555555      
î
DSK  SYSENG	FOO   	02:01:17	FRIDAY  MARCH 09,1973	NM+5D.0H.35M.44S.



   IIIIIIIII         TTTTTTTTTTTTTTT         SSSSSSSSS      
   IIIIIIIII         TTTTTTTTTTTTTTT         SSSSSSSSS      
   IIIIIIIII         TTTTTTTTTTTTTTT         SSSSSSSSS      
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS               
      III                  TTT            SSS               
      III                  TTT            SSS               
      III                  TTT               SSSSSSSSS      
      III                  TTT               SSSSSSSSS      
      III                  TTT               SSSSSSSSS      
      III                  TTT                        SSS   
      III                  TTT                        SSS   
      III                  TTT                        SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
      III                  TTT            SSS         SSS   
   IIIIIIIII               TTT               SSSSSSSSS      
   IIIIIIIII               TTT               SSSSSSSSS      
   IIIIIIIII               TTT               SSSSSSSSS      

DSK  SYSENG	FOO   	02:01:17	FRIDAY  MARCH 09,1973	NM+5D.0H.35M.44S.



777777777777777         888888888         555555555555555   
777777777777777         888888888         555555555555555   
777777777777777         888888888         555555555555555   
            777      888         888      555               
            777      888         888      555               
            777      888         888      555               
         777            888888888         555555555555      
         777            888888888         555555555555      
         777            888888888         555555555555      
      777            888         888                  555   
      777            888         888                  555   
      777            888         888                  555   
   777               888         888                  555   
   777               888         888                  555   
   777               888         888                  555   
777                  888         888      555         555   
777                  888         888      555         555   
777                  888         888      555         555   
777                     888888888            555555555      
777                     888888888            555555555      
777                     888888888            555555555      
î   001		                                                                      PAGE 1
   002		TITLE ITS
   003		.SYMTAB 10000.
   004	001 006	IF1 [ PRINTX \AI = \
   005	001 018	.TTYMAC A
   006	001 018	AI==A+IFB A,1	;1 FOR AI, 0 FOR MATHLAB
   007	001 006	IFB A,[PRINTX \AI = 1
   008		\]
   009		TERMIN  ]
   010		
   011		OQDTSW==1	;NON ZERO => STORE OLD STYLE DATE ON DSK (EVENTUALLY FLUSH)
   012		EXPGNG==4	;4 TO TURN ON EXEC PAGING
   013		PCLSW==1	;1 ASSEMBLE PCLSR TEST FEATURE
   014		.MLLIT==1	;MULTI-LINE LITERAL MODE
   015		
   016		;AC DEFS
   017		
   018		A=1
   019		B=2
   020		C=3
   021		D=4
   022		E=5
   023		TT=6
   024		I=7
   025		Q=10
   026		J=11
   027		R=12
   028		W=13
   029		H=14
   030		P=15	;DO NOT CHANGE!	;PDL POINTER
   031		T=16	;"
   032		U=17	;"		;USER INDEX
   033		
   034	001 032	.XCREF A,B,C,D,E,TT,I,Q,J,R,W,H,P,T,U
   035		YEAR==73.	;BASE YEAR LOW BIT ONLY STORED IN FILE
   036		YEARPH==-1	;1 OR -1 AS FOLLOWS
   037		;IF LBT (YEAR) .NE. LBT (STORED YEAR) THEN COMPLETE STORED YEAR = YEAR+YEARPH
   038		
   039		IF1 EXPUNGE APR,OCT,DEC	;FOR NEW CALENDAR HACK
   040		
   041		NULBLK==4	;NUMBER OF LOCKED SWITCH BLKS IN USR VARIABLES
   042				;USES 2 WDS OF USER VAR PER
   043		
   044		MAXJ==50.	;MAX JOBS ALLOWABLE
   045	001 044	IF2 LIOBLK==1+<USRSTG+LUBLK*MAXJ>_-10.	;LOWEST BLOCK NEVER TO BE SHUFFLED
   046					;ALSO MAX # OF BLOCKS SYS JOB MAY HAVEî   001		                                                                      PAGE 2
   002		;INTERRUPT BITS IN PIRQC
   003		TTYIF==1	;CONSOLE INPUT INTERRUPT BUF NOT EMPTY
   004		BCNTRZI==2	;^Z TYPED
   005		BPIPI==4	;BAD LOC 42
   006		AROIF==10	;AROV
   007		BDISP==20	;DISPLAY MEMORY PROTECT
   008		BILLOP==40	;ILLEGAL INSTRUCTION
   009		BSYSDN==100	;SYSTEM GOING DOWN  OR REVIVED
   010		VALRTF==200	;VALUE RETURN
   011		BIOCER==400	;CHANNEL ERROR
   012		ILLUAD==1000	;USER DOES NOT HAVE THAT MUCH CORE
   013		BRKF==2000	;BREAKPOINT FLAG
   014		BPROC==4000	;SINGLE INSTRUCTION PROCEED
   015		BSCLK==10000	;CLOCK INT
   016		BIOADC==20000	;MEMORY PROTECTION VIOLATION
   017		BMARI==40000	;MAR INTERRUPT
   018		BLTP==100000	;LIGHT PEN
   019		;200000	PDL OV
   020		BCLI==400000	;CLI DEVICE INTERRUPT
   021		BRESTR==1,,	;RESTRICTION VIOLATION
   022		BDBGI==2,,	;SYS BEING DEBUGGED
   023			ATPSFT==20.	;SHIFT TO TAKE LOW ORDER BIT TIPBK1
   024		ARMTP1==4,,	;ARM TIP BREAK 1 (THESE MUST BE CONSECUTIVE BITS)
   025		ARMTP2==10,,	;ARM TIP BREAK 2
   026		ARMTP3==20,,	;ARM TIP BREAK 3
   027		BUTRAP==40,,	;SYS UUO TO USER TRAP
   028		BPURE==100,,	;PURE TRAP
   029		BWIRO==200,,	;ATTEMPTED WRITE INTO RD ONLY
   030		ARFOIF==400,,	;ARITHMETIC FLOATING OVERFLOW
   031		BRTIME==100000,,	;RUN TIME INT.
   032		NCLOKB==200000,,	;SEE AREALT
   033		
   034		;IN BADBTS => CLASS 2 OR 1 INTERRUPT   ;IN VBDBTS=> CLASS 1 INTERRUPT
   035	002 014	VBDBTS==BPIPI+VALRTF+BRKF+BCNTRZI+BPROC
   036	002 029	BADBTS==VBDBTS+BIOADC+BIOCER+BILLOP+BMARI+BDISP+ILLUAD+BRESTR+BUTRAP+BPURE+BWIRO
   037		
   038		LPM=102000,,	;LOAD PG MEM STATE VECTOR DONT CLR ASSOC MEM
   039	002 038	LPMR= LPM 2,	;CLEAR ASSOC MEM AND LOAD
   040	002 038	SPM= LPM 1,	;STORE PG MEM STATE VECTOR
   041	002 038	LPMRI=LPM 6,	;LOAD PM, CLEAR ASSOC REG, AND CAUSE INTERRUPT
   042		XCTR=103000,,	;VIOLATION CAUSES USER MEM PROTECT INTERRUPT UNLESS INHIBITED
   043				;VIOLATION ALSO SKIPS BUT THIS IS OF NO CONSEQUENCE UNLESS
   044				;INTERRUPT IS INHIBITED SINCE PC WILL BE RESET FROM OPC
   045		
   046		XR==1	;MAP READ ALLOW USER MEM PROTECT INTERRUPTS
   047		XW==2	;MAP WRITE
   048		XRW==3	;MAP BOTH
   049		XI==4	;MAP NONE BUT INHIBIT INTERRUPTS IF PG FAULT
   050		XRI==5	;MAP READ AND INHIBIT USER MEM PROTECT ETC
   051		XWI==6	;MAP WRITE AND INHIBIT
   052		XRWI==7	;MAP BOTH AND INHIBIT
   053		
   054		USPM=107000,,	;SOFTWARE "USER" SPMî   001		                                                                      PAGE 3
   002		IOTFLG==4000	;IOT USER FLAG IN PC WORD
   003		BADPC==5037	;PC BITS NOT PERMITTED FOR USER TO CONTROL (SPECIAL AND IOT USER)
   004		LSRMOD==10000	;USER MODE BIT IN PC WORD
   005		BPCROC==400	;ONE PROCEED BIT IN PC
   006		
   007		UUOMIN==40000,,	;SMALLEST NUM THAT COULD BE A SYSTEM CALL
   008		UUOMAX==50000,,	;ONE GREATER THAN LARGEST NUM "
   009	003 008	AUUO=UUOMAX	;USE TO SAVE CONDS ON ILLOP
   010	003 009	UTRAP=AUUO+1_27.	;USE FOR USER SYS UUO TRAP
   011	003 009	UIOT=AUUO+2_27.	;USE FOR USER I/O INST TRAP
   012		ITSVRS==.FNAM2
   013	058 006	IF1,[ASMDAT==.OP <.OPER@> 0,.RDATE
   014	058 006	ASMTIM==.OP <.OPER@> 0,.RTIME
   015		]
   016		
   017			;MAX DYN ALLOC ALLOC IO BUFFERS
   018		MXIOB==370	;MAX POSSIBLE
   019		
   020		SIOMT==30	;MAX SIZE TRANSLATION TABLE
   021		
   022		LUPDL==50	;LENGTH USER PDL MUST BE >= 40 FOR 2311 GC
   023		LUIOP==20	;LENGTH OF USER IO PDL
   024		CPDLL==20	;LENGTH CLOCK CHANNEL PDL
   025		LUTCP==20	;LENGTH UTC PDL
   026		LSYSP==40	;SYSTEM JOB PDL
   027		
   028		DMNSZ==5	;# ENTRIES IN DEMON BUFFER (DMNBF)
   029		
   030		MXCZS==5	;MAX NUMBER ^Z'S PER CLOCK BREAK
   031		
   032		SCLKI==30.	;60'THS PER SLOW CLOCK
   033		VSCLKI==2*60.*60.	;60'THS PER VERY SLOW CLOCK TICK
   034		MXOPT==8.	;SLOW CLOCK  MAX UT OP CAN TAKE
   035		NINFP==8.	;MAX. NO. OF INF. PROCED. / PROCED.
   036		î   001		;"INSTALLATION" RELATED SWITCHES                                      PAGE 4
   002		
   003	001 006	IFN AI,[
   004		340P==1		; HAS 40
   005		TABP==1		; HAS SYLVANIA TABLET
   006		DSDP==1		; HAS DESELECTION DEVICE
   007		NEWDTP==0	;1 HAS NEW DECTAP CONTROL (DC-10)
   008		DECDKC==0	;1 HAS DEC DISK CONTROL
   009		NUNITS==4	;NUMBER UTAPE UNITS
   010		NMTCS==1	;NUMBER MAG TAPE UNITS
   011		OLPTP==1	; HAS OLPT
   012		NLPTP==1	;HAS NEW LPT
   013		PLTP==1		;HAS PLOTTER
   014		ARMP==1		;HAS ARM (AMF MOSTLY)
   015		OMXP==1		;HAS OMX
   016		IMXP==1		;HAS IMX
   017		VIDP==1		;HAS VIDI
   018		TK10P==1	;HAS TK10 TTY SCANNER
   019		MTYP==0		;1 HAS MORTON MULTIPLEX BOX
   020		CODP==1		;CODE OUTPUT DEVICE
   021		PDP6P==1	;PDP6 FEATURES
   022		HCLKP==1	;HOLLOWAY CLOCK
   023		PDCLKP==1	;"DECORIOLIS" CLOCK
   024		RBTCP==1	;ROBOT CONSOLE
   025		DPKPP==1	;DATA POINT KLUDGE
   026		NETP==1		;ARPA NET CONNECTION
   027		CCLKP==0	;CHESS TOURN CLOCK STUFF
   028		TPLP==1		;PSEUDO LPT
   029		C1MXP==1	;CHNL 1 MPX FEATURE
   030		NDAP==1		;NEW D/A CONVERTERS
   031		NNVTTS==0	;# NOVA TTYS
   032		NNTYS==16.	;# TTYS ON KNIGHT KLUDGE
   033		NDPTYS==16.	;# TTYS ON DATAPOINT KLUDGE
   034		NMTYS==0	;# TTYS ON MORTON BOX
   035		NQS==3		;# 2314 UNITS
   036		SYSCON==5	;SYSTEM JOB CONSOLE
   037		APL==10		;AP TTY #
   038		STKP==1		;HAS STANFORD KEYBOARD
   039		TSYSM==256.+16.	;TOTAL PDP10 1K MEM BLOCKS
   040		DDTPGS==16.	;PGS TO LEAVE FOR DDT (AT HIGH END OF LOW MOBY)
   041		]
   042		
   043	001 006	IFE AI,[
   044		340P==0
   045		TABP==0
   046		DSDP==0
   047		NEWDTP==1
   048		DECDKC==1
   049		NMTCS==1
   050		OLPTP==0
   051		NLPTP==0
   052		PLTP==0
   053		ARMP==0
   054		OMXP==0
   055		IMXP==0
   056		VIDP==0
   057		PDP6P==0
   058		HCLKP==0
   059		PDCLKP==1
   060		RBTCP==0
   061		DPKPP==0                                                              PAGE 4.1
   062		NUNITS==4
   063		CODP==0
   064		TK10P==0
   065		MTYP==1
   066		NETP==1
   067		CCLKP==0
   068		TPLP==0
   069		C1MXP==1
   070		NDAP==0
   071		NNVTTS==0
   072		NNTYS==0
   073		NDPTYS==0
   074		NMTYS==21
   075		NQS==2
   076		SYSCON==4
   077		APL==0		;NO AP LINE
   078		STKP==0
   079		TSYSM==256.+64.	;512 SOON?
   080		DDTPGS==16.
   081		]î   001		                                                                      PAGE 5
   002	004 012	LPTP==OLPTP+NLPTP
   003	004 005	IFN TABP,	TABCLK==0	;1=>PUT TABLET ON CLOCK CHNL
   004		
   005		;PRIORITY INTERRUPT CHANNEL ASSIGNMENTS
   006			DCCHN==1	;DC CHANNEL
   007	005 006		DCLOC=40+2*DCCHN	;DC INTERRUPT LOCATION
   008		
   009	004 026	IFN NETP,[
   010			IMPCHN==1	;IMP STUFF
   011			NETCHN==2	;SOFTWARE ACTIVATED...
   012		]
   013			UTCCHN==2	;UTC CHANNEL
   014	005 013		DSKCHN==UTCCHN	;2314 CHANNEL
   015	005 013	IFN NMTCS,	MTCCHN==UTCCHN	;MAG TAPE CONTROL CHANNEL
   016	005 002	IFN LPTP,	LPTCHN==4	;LINE PRINTER CHANNEL
   017				TTYCHN==3	;TTY CHANNEL
   018	004 013	IFN PLTP,	PLTCHN==4	;PLOTTER CHANNEL
   019				PCHCHN==4	;PTP CHANNEL
   020				PTRCHN==4	;PAPER TAPE READER CHANNEL
   021	004 004	IFN 340P,	SDCHN==4	;DISPLAY SPECIAL CHANNEL
   022	004 006	IFN DSDP,	DSDCHN==4	;INTERRUPT FROM OTHER PROCESSOR
   023	004 014	IFN ARMP,	TIPBCH==5	;ARM TIP BREAK CHNL
   024	004 015	IFN OMXP,	OMPCHN==5	;OUTPUT MULTIPLEXOR
   025	004 017	IFN VIDP,	NVDCHN==5	;NEW VIDI
   026	005 003	IFN TABP,	IFE TABCLK,	TABCHN==5	;TABLET
   027	004 004	IFN 340P,	DISCHN==6	;DISPLAY DATA CHNL
   028	005 003	IFN TABP,	IFN TABCLK,	TABCHN==7	;TABLET
   029				APRCHN==7	;DO NOT CHANGE
   030		
   031				PICOFF==1200	;TURN OFF PI CHANNEL
   032				PICON==2200	;TURN ON PI CHANNEL
   033				PICIRQ==4200	;REQUEST INTERRUPT ON PI CHANNEL
   034		
   035				CLKON==2201	;ABSOLUTE
   036				CLKOFF==1201
   037	005 024	IFN OMXP,	OMXON==CLKON\<400_-OMPCHN-1>
   038	005 024	IFN OMXP,	OMXOFF==CLKOFF\<400_-OMPCHN-1>
   039	005 016	IFN LPTP,	LPTON==CLKON\<400_-LPTCHN-1>
   040	005 016	IFN LPTP,	LPTOFF=CLKOFF\<400_-LPTCHN-1>
   041	005 019			PTPON==CLKON\<400_-PCHCHN-1>
   042	005 019			PTROFF==CLKOFF\<400_-PCHCHN-1>
   043	005 020			PTRON==CLKON\<400_-PTRCHN-1>
   044	005 020			PTROFF==CLKOFF\<400_-PTRCHN-1>
   045	005 017			TTYON==CLKON\<400_-TTYCHN-1>
   046	005 017			TTYOFF==CLKOFF\<400_-TTYCHN-1>
   047	005 013			UTCON==CLKON\<400_-UTCCHN-1>
   048	005 013			UTCOFF==CLKOFF\<400_-UTCCHN-1>
   049	004 026	IFN NETP,[
   050	005 047			NETON==UTCON
   051	005 048			NETOFF==UTCOFF
   052		]
   053	004 005	IFN TABP,[
   054		
   055	005 003	IFN TABCLK,[
   056	005 035	TABON==CLKON
   057	005 036	TABOFF==CLKOFF
   058		]
   059	005 003	IFE TABCLK,[
   060	005 026	TABON==CLKON\<400_-TABCHN-1>
   061	005 026	TABOFF==CLKOFF\<400_-TABCHN-1>                                        PAGE 5.1
   062		]
   063		]
   064		
   065	005 013	IFE NEWDTP,	CUINT==5000+UTCCHN	;CONO TO UTC TO ACTIVATE UTAPE INTERRUPT
   066		
   067	004 021	IFN PDP6P,	PDP6BM==1,,40000	;BASE ADR OF FIRST 16K PDP-6 MEM AS SEEN BY 10î   001		                                                                      PAGE 6
   002		;DEVICE CODES
   003	004 038	IFN STKP,	STK==70		;STANFORD KEYBOARD
   004	004 011	IFN OLPTP,	OLPT==124	;LINE PRINTER
   005	004 012	IFN NLPTP,	NLPT==464
   006	004 010	IFN NMTCS,	MTC==340	;MAG TAPE CONTROL
   007	004 010	IFN NMTCS,	MTS==344	;MAG TAPE STATUS
   008	004 017	IFN VIDP,	NVDX==620	;NEW VIDI X
   009	004 017	IFN VIDP,	NVDY==624	;NEW VIDI Y
   010	004 017	IFN VIDP,	NVDT==630	;NEW VIDI T (DEFLECTION DELAY)
   011	004 013	IFN PLTP,	PLT==654	;CAL COMP PLOTTER
   012	004 022	IFN HCLKP,	CLK1==710	;HOLLOWAY CLOCK
   013	004 022	IFN HCLKP,	CLK2==714	; "
   014	004 016	IFN IMXP,	MPX==574	;INPUT MULTIPLEXOR
   015	004 015	IFN OMXP,	OMPX==570	;OUTPUT MULTIPLEXOR
   016	004 018	IFN TK10P,	NTY==600	;KNIGHT TTY KLUDGE
   017	004 019	IFN MTYP,	MTY==400
   018	004 023	IFN PDCLKP,	PDCLK==500	;DE-CORIOLIS CLOCK
   019	004 006	IFN DSDP,	DSDEV==20	;DE SELECTION AND INTER COM DEVICE
   020	004 006	IFN DSDP,	DSDEVN==24	;DE SELECTION DEV (FOR DEVICES YOU DATAO DEV CODE TO DSDEVN)
   021	004 014	IFN ARMP,	TIPDEV==504	;TIP BREAK DEVICE
   022	004 024	IFN RBTCP,	RBTCON==514	;ROBOT CONSOLE
   023	004 025	IFN DPKPP,	DPK==604	;DATA POINT KLUDGE
   024	004 008	IFE DECDKC,	DC0==610	;2314 DISK CONTROL
   025	004 008	IFE DECDKC,	DC1==614	;2314 DISK CONTROL
   026	004 026	IFN NETP,	IMP==460	;NET INTERFACE
   027	004 007	IFN NEWDTP,[
   028				DTC==320
   029				DTS==324
   030		]
   031	004 008	IFN DECDKC,	DPC==250
   032	004 026	IFN NETP,[
   033	001 006		IFN AI,IMPUS==206	;AI NETWORK HOST NUMBER
   034	001 006		IFE AI,IMPUS==306
   035		]
   036		
   037	004 017	IFN DSDP,	IFN VIDP,	DSNVID==200000,,	;DEASSIGN BIT FOR NVD
   038	004 004	IFN DSDP,	IFN 340P,	DSNDIS==4000,,	;DEASSIGN BIT FOR DIS
   039	004 010	IFN DSDP,	IFN NMTCS,	DSMTC==1,,	;DEASSIGN BIT FOR MAG TAPE
   040		
   041	004 024	IFN RBTCP,	RLTSWC==17	;ROBOT CONSOLE SELECT FOR LIGHTS AND SWITCHES
   042	004 005	IFN RBTCP,	IFN TABP,	RTABC==16	;ROBOT CONSOLE SELECT FOR TABLET
   043		
   044	004 016	IFN IMXP,	LCHN==177	;MULTIPLEXOR LIMIT ON READ IN
   045		
   046				NUTIC==8	;NUMBER UT IN CHNLS
   047				NUTOC==8	;NUMBER UT OUT CHNLS
   048	006 047			NFCLC==NUTIC+NUTOC+1	;# OF FIRST CORE LINK CHNL
   049				NCLCH==14	;NUMBER CORE LINK CHNLS
   050	006 049			NFNETC==NFCLC+NCLCH	;# OF FIRST NET CHNL
   051	004 026	IFN NETP,	NNETCH==20.		;# NET CHNLS
   052	004 026	IFE NETP,	NNETCH==0	;SO WILL BE DEFINED
   053				NUDCH==14	;NUMBER DIRECTORY CHNLS
   054	004 016	IFN IMXP,	NPOTCH==20.	;NUMBER POT CHANNELS
   055				NQCHN==30.	;NUMBER 2314 CHNLS
   056		
   057	004 020	IFN CODP,	CODBFL==5	;CODE BUFFER
   058				PUNSIZ==20	;PTP BUF SIZ
   059				REDSIZ==200	;PTR BUF SIZ
   060	004 013	IFN PLTP,	LPLBUF==200	;PLT BUF SIZ
   061	005 002	IFN LPTP,	LPTBSZ==1000	;LPT BUF SIZ                          PAGE 6.1
   062	004 017	IFN VIDP,	NVDLNG==340	;NVD BUF SIZE
   063	004 028	IFN TPLP,	TPLBSZ==100	;TPL BUFFER SIZE IN SYS JOB
   064	004 005	IFN TABP,	LTABBF==100	;TABLET BUFFER
   065		
   066		EOFCH==3	;SYSTEM END OF FILE CHR
   067	006 066	EOFWRD=REPEAT 5,[EOFCH_<.RPCNT*7+1>\]0	;WORD OF EOFCH'S
   068		
   069	004 004	IFN 340P,	DVEF==4000	;DISPLAY VERTICAL EDGE FLAG
   070	004 004	IFN 340P,	DHEF==1000	;DISPLAY HOR EDGE FLAG
   071		
   072	004 004	IFN 340P,	EWRT==400./12.	;EQIV "COST" IN DISPLAY WRDS FOR TRIP THRU RECYC
   073	004 004	IFN 340P,	MDISWD=70000	;MAX # WDS SENT TO SCOPE IN 1/2 SEC
   074		
   075		NXLBYT==2	;# OF EXTRA CHRS IN LOAD ADR IN FILE DESC
   076				;MUST BE AT FRONT OF FILE
   077	004 016	NSWPV==340P+VIDP+IMXP	;# OF DEVICES THAT CAN SWAPIN PAGES
   078		
   079	004 029	IFN C1MXP,[
   080	004 010	IFN NMTCS,	MAGLOC==76	;INTERRUPT LOCS FOR MAGTAPE
   081				DCMLOC==74	;"      "    FOR DC
   082				IMXLC==66	;"     "   IMX
   083	004 026	IFN NETP,[
   084				IMPILC==70	;INPUT FROM IMP
   085				IMPOLC==72	;OUTPUT TO IMP
   086		]
   087		]
   088		
   089	004 029	IFE C1MXP,[
   090	004 010	IFN NMTCS,	MAGLOC==42
   091				DCMLOC==42
   092		]î   001	004 013	IFN PLTP,[                                                            PAGE 7
   002		;PLOTTER CONTROL BITS
   003		SD==4000
   004		PD==10000
   005		PUP==200
   006		PDN==400
   007		SDC==20000
   008		PDC==40000
   009		SDS==1000
   010		PDS==2000
   011		]
   012		
   013		;SYS PERIPHERAL DEVICE CODES
   014		
   015		;1.6 INDICATES DIRECTORY DEVICE
   016		;1.5 INDICATES NON PHYSICAL DEVICE
   017		
   018		SNTTY==1
   019		SNTDS==2	;TERMINAL DISPLAY
   020		SNLPD==3	;DATA PRODUCTS LPT
   021		SNVID==4
   022		SNBAT==5
   023		SNPLT==6
   024		SNPTP==7
   025		SNIMPX==10
   026		SNOMPX==11
   027		SNPTR==12
   028		SN340==13	;340 AS ASCII DEVICE
   029		SN340I==14	;INTERPRETED DISPLAY ON 340
   030		SNMTC==15	;MAGTAPE
   031		SNCOD==16	;CODE DEVICE
   032		SNTAB==17
   033		SNNUL==21
   034		SNJOB==22
   035		SNBOJ==23
   036		SNSPY==24
   037		SNSTY==25
   038		SNNET==26	;NETWORK
   039		SNLPV==27	;VOGUE LPT
   040		SNSTK==30	;STANFORD KEYBOARD
   041		SNUTC==41
   042		SN2311==43
   043		SNFUSR==60
   044		SNUSR==61
   045		SNCLK==62	;CLO, CLU, & CLI
   046		SNDIR==63
   047		SNPDP==64	;PDP6î   001		                                                                      PAGE 8
   002	001 035	EYEAR==YEAR
   003	001 036	IFN YEAR&1,EYEAR==YEAR+YEARPH
   004		LEYRP==0
   005	008 002	IFE EYEAR-<EYEAR/4*4>,LEYRP==1	;ONE IF EVEN REPRESENTED YEAR A LEAP YEAR
   006		
   007	001 035	LWYR==YEAR
   008	001 036	IFL YEARPH,LWYR==YEAR+YEARPH
   009		LWYLP==0
   010	008 007	IFE LWYR-<LWYR/4*4>,LWYLP==1	;LOW YEAR A LEAP YEAR
   011		
   012		SPD==60.*60.*24.	;# SECS IN A DAY (FITS IN A HALFWORD)
   013			PDUPS==60.	;# PDCLK INCREMENTS/SEC
   014		
   015		OPNCOM==410300	;COMMAND FIELD IN LH OF FIRST OPEN WORD
   016		
   017		;SYS IOC STATUS WORD FORMAT
   018		
   019		;RIGHT HALF WORD DEVICE STATUS
   020		;1.1-1.6 SYS PHYSICAL DEVICE CODE
   021		;1.7-1.9 OPEN MODE
   022		;2.1 SYS BUFF CAP FULL
   023		;2.2 "   "    "  EMPTY
   024		;2.9-2.3 DEVICE DEPENDANT
   025		
   026		;LEFT HALF WORD CHANNEL STATUS 
   027		;3.6-3.1 SET BY OPENS THAT DONT SKIP
   028		;1= NO SUCH DEVICE
   029		;2= WRONG DIRECTION
   030		;3= TOO MANY TRANSLATIONS
   031		;4= FILE NOT FOUND
   032		;5= DIRECTORY FULL
   033		;6= DEVICE FULL
   034		;7= DEVICE NOT IN READY STATUS
   035		;10= DEVICE NOT AVAILABLE
   036		;11= ILLEGAL FILE NAME
   037		;12= MODE NOT AVAILABLE
   038		;13= FILE ALREADY EXISTS (RENAME)
   039		;14= BAD CHANNEL NUMBER
   040		;15= TOO MANY ARGUMENTS (CALL)
   041		;16= PACK NOT MOUNTED
   042		;17= DIRECTORY NOT AVAIL NOW (ALL DIREC CHNLS IN USE)
   043		;20= USER DOESN'T EXIST
   044		;21= LOCAL DEVICE ONLY
   045		;22= SELF CONTRADICTORY OPEN COMMAND
   046		;23= ATT MODIFY WRITE ON FILE OPEN FOR READ
   047		;24= MFD FULL
   048		;25= DEVICE NOT ASSIGNABLE TO THIS PROCESSOR
   049		;26= DEVICE WRITE-LOCKED
   050		;27= LINK DEPTH EXCEEDED
   051		;30= TOO FEW ARGUMENTS (CALL)
   052		;31= CAN'T MODIFY JOB.
   053		;32= CAN'T GET ACCESS TO PAGE.
   054		;33= SELF-CONTRADICTORY ARGS (CALL)
   055		;34= WRONG TYPE DEVICE.
   056		;35= NO JOB WITH THAT NUMBER.
   057		;36= VALID CLEAR OR STORED SET (JOBRET, JOBGET)
   058		;37= NO CORE AVAILABLE.
   059		;40= NOT TOP LEVEL
   060		
   061		NOPNLS==40	;NUMBER OF CHNL STATUS LOSES USED                     PAGE 8.1
   062		NDOPL==7	;NUM OF DIS OPNL
   063		
   064		;4.5-3.7 SET BY IOC ERRORS AT IOT OR OPER TIME
   065		
   066		;3.9-3.7 SET BY 340 ROUTINES
   067		;1 ILLEGAL SCOPE MODE
   068		;2 SCOPE HUNG
   069		;3 MORE THAN 1K SYS SCOPE BUF
   070		;4 MEMORY PROTECT
   071		;5 ILLEGAL SCOPE OP
   072		;6 MEMORY PROTECT ON PDL POINTER
   073		;7 ILLEGAL PARAMETER SET
   074		
   075		;4.5-4.1
   076		;11 ILLEGAL CHR AFTER ^P ON TTY DISPLAY
   077		;10 CHNL IN ILLEGAL MODE WHEN .IOT ATTEMPTED
   078		;9 DEVICE FULL
   079		;8 CHANNEL NOT OPEN
   080		;7 CHANNEL DOES NOT HAVE A USER OPEN ON IT
   081		;6 ATTEMPT TO OVER IOPUSH
   082		;5 ATTEMPT TO OVER IOPOP
   083		;4 NON-EXISTANT SUB DEVICE
   084		;3 NON-RECOVERABLE DATA ERROR ;NON-EX-MEM ON PDP10 REF
   085		;2 ATT TO RANDOM ACCESS BEYOND END OF FILE
   086		;1 ILLEGAL HARDWARE OPERATION ATTEMPTED OR DEVICE HUNG
   087		
   088		MIOTER==1	;LOWEST IOCERR CODE USED
   089		NIOTER==13	;NUMBER "  "
   090		
   091		;4.9-4.5 ALWAYS ZERO (USED BY IOPUSH FOR CHNL NUM)
   092		
   093		;EXECUTIVE PAGE
   094		
   095		EXPGN==0
   096		DEFINE EXECPG A
   097	008 095	A==EXPGN
   098	008 095	EXPGN==EXPGN+1
   099	001 018	ZZQ==<A+1>&1
   100	001 018	ZZQQ==A_-1
   101	008 100	.!A==220000*ZZQ+2200,,ZZQQ
   102		TERMIN
   103		î   001		                                                                      PAGE 9
   002		FNM==.FNAM2	;SRI GETS VERSION NUMBER
   003				;WORKS FOR DECIMAL IGNORES LOW ORDER NON-NUMERIC CHRS
   004		DEFINE VNAM
   005	009 053	.TAG FOO
   006	009 002		ZZZQ==FNM&77
   007	009 006		IFGE ZZZQ-'0,IFLE ZZZQ-'9,.GO BAR
   008	009 002		FNM==FNM_-6
   009	009 053		.GO FOO
   010		.TAG BAR
   011			ZZZQ==1
   012			SRI==0
   013		.TAG MUM
   014	009 002		IFE FNM,.GO END
   015	009 002		ZCHR==FNM&77-'0
   016	009 015		IFL ZCHR,.GO END
   017	009 015		IFG ZCHR-9,.GO END
   018	009 015		SRI==SRI+ZZZQ*ZCHR
   019	009 006		ZZZQ==ZZZQ*10.
   020	009 002		FNM==FNM_-6
   021			.GO MUM
   022		.TAG END
   023			TERMIN
   024		
   025	009 004	IF1 VNAM
   026		
   027		DEFINE SRITYP A
   028		ZZZ==10	;SAVE OLD RADIX
   029		RADIX 10.
   030	001 006	IFN AI,[
   031	001 024		MOVEI I,[.ASCII ?
   032	001 018	AI ITS !SRI A?]
   033		]
   034	001 006	IFE AI,[
   035	001 024		MOVEI I,[.ASCII ?
   036	001 018	ML ITS !SRI A?]
   037		]
   038	009 028	RADIX ZZZ
   039			TERMIN
   040		
   041				;"MONTHS OF THE YEAR" MACRO
   042		
   043		DEFINE MNIRP A
   044	009 055	IRPS M,,[JAN FEB MAR APR
   045		MAY JUN JUL AUG
   046	500 106	SEP OCT NOV DEC]L,,[31. 29. 31. 30.
   047		31. 30. 31. 31.
   048		30. 31. 30. 31.]
   049	001 018	A
   050		TERMIN
   051		TERMIN
   052		
   053		FOO==-1	;ACCUMULATED VALUE FOR FOLLOWING DEFINITION:
   054		
   055	009 053	MNIRP [M==FOO
   056	500 106	FOO==FOO+L]	;JAN=-1, FEB=30., MAR=59., ETC.
   057		
   058		DEFINE CONC A,B
   059		A!B!TERMIN
   060		
   061		DEFINE	BUG RECOV,A/                                                  PAGE 9.1
   062			JRST 4,RECOV
   063		TERMINî   001		                                                                      PAGE 10
   002		DEFINE INFORM A,B
   003	001 019	IF1,[PRINTX \A = B
   004		\]TERMIN
   005		
   006		ZZZ==10
   007		RADIX 10.
   008	009 012	INFORM VERSION,\SRI
   009	001 006	INFORM AI,\AI
   010	009 028	RADIX ZZZ
   011		
   012		SSYS==0	;LENGTH OF SYS CODE
   013		
   014		DEFINE EBLK
   015	010 023	CONC CK,\CKNUM,==CKZZ-.,,CKZZ
   016	010 016	CKNUM==CKNUM+1
   017	010 023	SSYS==SSYS+.-CKZZ
   018	010 014	IFN CKPAR,A:	INFORM LOSS AT EBLK,\.
   019		CKPAR==1
   020		TERMIN
   021		
   022		DEFINE BBLK
   023		CKZZ==.
   024	010 022	IFE CKPAR,A:	INFORM LOSS AT BBLK,\.
   025		CKPAR==0
   026		TERMIN
   027		
   028		CKPAR==1
   029		CKNUM==0
   030		
   031		
   032		;INSERT CALL TO THIS MACRO AT ANY PLACE IT IS POSSIBLE TO PCLSR
   033		;(IF IT IS DESIRED FOR PCLSR TEST FEATURE TO TEST THAT SECTION)
   034		
   035		DEFINE PCLT
   036	001 013	IFN PCLSW,[
   037	494 033		SKIPE PCLDBM
   038	492 008		PUSHJ P,PCLTST
   039		]
   040		TERMIN
   041		
   042		DEFINE	PCLTH A
   043	001 013	IFN PCLSW,[
   044	494 033		SKIPN PCLDBM
   045			JRST .+3
   046	001 030		PUSHJ P,PCLTSH
   047	001 018		A
   048		]
   049		TERMINî   001		                                                                      PAGE 11
   002		PATB:
   003		LOC 20
   004	010 022		BBLK
   005		
   006	004 008	IFN DECDKC,[
   007		IF2,[
   008	449 082		LOC ICWA		;34
   009	010 014		EBLK
   010	449 082		LOC ICWA+2
   011	010 022		BBLK
   012		]
   013		IF1,[
   014	010 014		EBLK
   015	010 022		BBLK
   016		]
   017		]
   018		
   019		LOC 37
   020	010 014		EBLK
   021		LOC 41
   022	060 032		JSR UUOH	;UUO TRAP
   023		
   024	022 059		REPEAT 2,	JSR RINT1
   025	022 052		REPEAT 6*2,	JSR RINT	;INITIALIZE ANY UNUSED PI LOCNS
   026		
   027		LOC 61
   028	061 002		JSR 60H		;60 TRAP
   029	022 059	IFN C1MXP,	REPEAT 16.,	JSR RINT1	;INITIALIZE C1MPX LOCNS
   030		
   031	005 029	LOC 40+2*APRCHN
   032	013 040		JSR CLKBRK	;PROCESSOR OR CLOCK INTERRUPT
   033			JRST 4,.
   034		
   035	005 019	LOC 40+2*PCHCHN
   036	319 003		JSR LPTBRK	;LPT,DISPLAY,PTP,PTR,OTHER PROCESSOR
   037	273 005	IFN 340P,	JSR DRECYC	;HACK HACK
   038		
   039	005 017	LOC 40+2*TTYCHN
   040	180 004		JSR TTYBRK	;TTY,DATAPOINT KLUDGE
   041			JRST 4,.
   042		
   043	005 013	LOC 40+2*UTCCHN
   044	408 003		JSR UTCBRK	;MICRO TAPE OR DISK (S)
   045			JRST 4,.
   046		
   047	004 004	IFN 340P,[
   048	005 027	LOC 40+2*DISCHN
   049	291 066		BLKO DIS,DBLKOP	;340 DISPLAY BLKO
   050	005 021		CONO PI,4000+200_<-SDCHN>	;HACK HACK
   051		]
   052		
   053	004 017	IFN VIDP,[
   054	005 024	LOC 40+2*OMPCHN
   055	344 026		JSR OMPXBK	;OUTPUT MPXR, NVID, ETC.
   056			JRST 4,.
   057		]
   058	004 026	IFN NETP,[
   059	005 010	LOC 40+2*IMPCHN
   060			JSR IMPBRK
   061	006 084	LOC IMPILC                                                            PAGE 11.1
   062			JSR IMPIBK
   063			0
   064	006 085	LOC IMPOLC
   065			JSR IMPOBK
   066			0
   067		]
   068		
   069	011 002	LOC PATBî   001		                                                                      PAGE 12
   002		DEFINE	PI2SAF
   003			CONSO PI,20000
   004			CONSO PI,40
   005			JRST .+2
   006			JRST 4,.	;PI 2 NOT OFF OR NOT IN PROGRESS
   007		TERMIN
   008		
   009			NMMP==3	;# EXEC PAGES FOR MMP TABLE
   010	004 004	IFN 340P,	N340PB==10.	;# EXEC PGS USED FOR 340 DATA MUST BE EVEN
   011			NUVPG==256.	;SIZE USR PRGM THAT PAGE TABLE VARS CAN BE
   012					;ACCOMODATED IN USR VARIABLES
   013		;CIRCULAR PAGE LINK FORM
   014		;2.9=0
   015		;1.1-1.8 PAGE #
   016		;2.8-1.9 USER #
   017		;2.9=1
   018		;2.8=0 2.7-1.1 LINK TO MMP TABLE
   019		;2.8=1 2.7-1.1 LINK TO MEM PNT TABLE
   020		;EXCEPT 2.9-1.1=777777 => ABSOLUTE PAGE, NOT LINKED
   021		
   022	004 040	SYSUSM==TSYSM-DDTPGS	;LEFT AFTER ROOM FOR DDT
   023		;EXEC MAP ASSIGNMENTS
   024	004 004	IFN 340P,[
   025	008 096	EXECPG 340P1,	;USED TO FETCH + TRACE 340 PNTRS
   026	008 096	EXECPG 340P2,
   027	008 096	REPEAT N340PB,CONC [EXECPG DPG]\.RPCNT,;	;DATA AREA PNTRS FOR 340 DATA
   028		]
   029	008 096	EXECPG CORJF,	;CORE JOB FROM PAGE
   030	008 096	EXECPG CORJT,	;CORE JOB TO PAGE
   031	004 017	IFN VIDP,[
   032	008 096	EXECPG VSB1,	;.VSCAN B1
   033	008 096	EXECPG VSB2,	;.VSCAN B2
   034		]
   035	008 096	REPEAT NMMP,CONC [EXECPG MMP]\.RPCNT,;	;MMP TABLE
   036	008 096	EXECPG PAREP,	;USED BY SYSTEM IN ITS DILIGENT EFFORTS TO FIX PARITY ERRORS
   037		
   038	008 095	NEXPGS==EXPGN	;# EXEC PGS USEDî   001			;FOR VARIABLES (MONITORABLE WITH KEYS)                        PAGE 13
   002		NSKED:	0	;# TIMES SCHED RUN
   003		NUINT:	0	;# TIMES USER GIVEN INTERRUPT
   004		NAUINT:	0	;# ATTEMPTED USER INT (POSSIBLY UNSUCCESSFUL DUE TO PG FAULT)
   005		NPCLSR:	0	;# ATT TO PCLSR
   006		NSOUSR:	0	;# ATT TO SWAP OUT USR
   007		NSOPGS:	0	;# TIMES THRU LOOP LOOKING FOR PG TO SWAP OUT
   008		NPGSO:	0	;# TIMES AT SWOPG
   009		NPGFLT:	0	;# PAGE FAULT (ALL CAUSES)
   010		NCLKI:	0	;# CHNL 7 INTS (ALL CAUSES)
   011		NPGLD:	0	;# TIMES AT PGLDU
   012		NUFLS:	0	;# TIMES AT UFLS
   013		NTUSB:	0	;# TIMES USER SWAP BLOCKED
   014		NTSBUP:	0	;# TIMES SWAP BLOCKED USER TOOK PAGE FAULT AND LET IN
   015		NTSBUB:	0	;# TIMES SWAP BLOCKED USER TOOK PAGE FAULT AND BLOCKED
   016		NTSBUU:	0	;# TIMES SWAP BLOCKED USER UNBLOCKED BEFORE TIME (MEM APPARENTLY AVAIL)
   017		
   018		;THE FOLLOWING FOUR MUST BE CONSECUTIVE
   019		NRPI:	0	;# REFS TO PAGE IN (BUT MAP WAS NOT SET UP, ETC)
   020		NRPCI:	0	;# PAGE FAULTS REFS TO PAGE COMMING IN
   021		NRPO:	0	;# REFS TO PAGE OUT
   022		NRPGO:	0	;# TO PAGES GOING OUT
   023		
   024		PAT:
   025	011 002	LOC PATB+40
   026		
   027	010 022	BBLK
   028		
   029		PATCH:	BLOCK 140	;PATCH SPACE CODE AND CONSTANTS
   030		
   031	010 014	EBLK
   032		
   033		VPATCH:
   034		VPAT:
   035		BLOCK 40	;PATCH SPACE VARIABLES
   036		
   037		;
   038		; PROCESSOR BREAK ROUTINES
   039		;
   040		CLKBRK:	0	
   041		;
   042	013 040	INFORM CLKBRK+1,\.
   043		;
   044	010 022	BBLK
   045		;
   046	494 072		SKIPE SYSDBG
   047	013 095		JRST CLKBR1
   048	013 010	CLKBR2:	AOS NCLKI
   049	060 031		XCT CLUSAV	;STORE U IN AC17S FOR CURRENT USER (UNLESS NULL JOB)
   050	493 027		SKIPGE U,USER	;PICK UP INDEX OF CURRENT USER, SKIP UNLESS NULL JOB
   051	013 058		JRST CLKBKR	;JUMP IF NULL JOB WAS RUNNING
   052	500 014		SPM UPGML(U)	;STORE PAGE MAP AWAY
   053	494 049		AOSN UFLSF	;SKIP UNLESS GOT HERE FROM UFL6
   054	013 088		JRST CLUFLS
   055	498 031		MOVEM T,AC16S(U)	;STORE AWAY T
   056	498 029		MOVEI T,AC0S(U)
   057	498 030		BLT T,AC15S(U)	;STORE REST OF ACS
   058	494 002	CLKBKR:	MOVE P,CPDLP	;SET UP CLOCK LEVEL PDL
   059			CONSZ 270220	;CHECK PDL OV, MEM PROTECT, NXM, FOV, AR OV
   060	016 002		JRST CLKB1	;JUMP ON LOSSAGE
   061		CLKB1D:	CONSO 1000	;SKIP ON CLOCK BREAK                          PAGE 13.1
   062	023 038		JRST CLKB1E	;JUMP ON PARITY ERROR OR SPURIOUS INT
   063		;IFN 340P,	DATAI CLK1,LQTIM
   064	494 004		SOSG @CLROOT	;COUNT DOWN, SKIP IF NOT TO NEXT REQUEST
   065	014 003		JRST CLQBRK	;SERVICE CLOCK QUEUE REQUEST
   066	005 029	CLQBRT:	CONO 1000+APRCHN	;RESET CLOCK INTERRUPT
   067	004 004	IFN 340P,[
   068	291 036		AOSGE T,DTIME
   069	013 078		JRST DSTPD	;WAIT IF DTIME CLOBERED DUE TO RATE EXCEEDED
   070	001 031		CAILE T,2
   071	001 031		MOVEI T,2
   072	291 036		MOVEM T,DTIME
   073	260 020		SKIPL CDISOF
   074	291 035		SKIPGE DISOFF
   075	013 078		JRST DSTPD
   076	291 068		AOSG DISON
   077	005 027		CONO DIS,1100\SDCHN_3\DISCHN	;RESTART DISPLAY
   078		DSTPD:
   079	494 052	]	SKIPGE 27FCLK
   080	199 065		PUSHJ P,TYP27S
   081	494 050		SETCMM CLKFL1
   082	494 050		SKIPL CLKFL1
   083	497 003		AOS TIME	;GET HERE EVERY THIRTIETH OF A SECOND
   084	494 051		AOSG SCHFLG
   085	037 037		JRST CLKB5	;TIME NOT UP
   086	029 004		JRST SCHED	;SCHEDULE
   087		
   088	005 035	CLUFLS:	CONO PI,CLKON	;FROM UFLS
   089	494 002		MOVE P,CPDLP
   090	498 016		MOVE T,UPC(U)
   091	013 040		MOVEM T,CLKBRK
   092	013 012		AOS NUFLS
   093	029 008		JRST SCHED2
   094		
   095	494 025	CLKBR1:	DATAI GODDT
   096	494 025		SKIPGE GODDT
   097	502 007		JRST DDT
   098	013 048		JRST CLKBR2î   001		                                                                      PAGE 14
   002			;CLOCK QUEUE SERVICE
   003	494 004	CLQBRK:	SKIPG U,CLROOT	;GET POINTER TO CURRENT BLOCK
   004	009 061		BUG .,CLK QUEUE SCREWED
   005	001 031		SKIPG T,1(U)	;GET POINTER TO NEXT BLOCK
   006	009 061		BUG .,CLK QUEUE SCREWED
   007			SETOM 1(U)	;INDICATE CURRENT BLOCK IDLE
   008	494 004		MOVEM T,CLROOT	;SET UP POINTER FOR NEXT BLOCK
   009			XCT 2(U)	;EXECUTE REQUEST (PROBABLY A JRST)
   010				;FALL THROUGH IF SINGLE INST RQ
   011		CLQRET:		;RETURN FROM REQUEST
   012	494 004		SKIPN @CLROOT	;SKIP IF TIME TILL NEXT RQ NONZERO
   013	014 003		JRST CLQBRK	;ZERO TIME DELTA, DO NEXT RQ
   014	013 066		JRST CLQBRT	;RETURN TO CLOCK ROUTINE
   015		
   016	014 011	CLQTTR:	JUMPE TT,CLQRET	;COMMON RETURN FOR TT IDLE FLAG
   017	014 011	CLQREE:	MOVEI E,CLQRET	;RE ENTER RQ
   018		
   019		;CLOCK OFF OR IN PROGRESS LEVEL ADD TO CLOCK QUEUE, CALL BY JSP E,
   020			; T HAS TIME TILL RQ IN 60'THS
   021			; C POINTS TO THREE WORD BLOCK, RQ'ED INST IS IN THIRD
   022	494 004	CLQPUT:	MOVEI B,CLROOT-1
   023	001 019	CLQPU2:	MOVE A,B	;REPLACE POINTER TO PREV BLOCK WITH CURRENT
   024	001 019		SKIPG B,1(B)	;GET LINK TO NEXT BLOCK
   025			JRST 4,.
   026	001 031		SUB T,(B)	;SUBTRACT TIME DELTA FOR NEXT BLOCK
   027	014 023		JUMPG T,CLQPU2	;JUMP IF RQ LATER THAN CURRENT BLOCK
   028	014 037		JUMPE T,CLQPU6	;JUMP IF RQ SAME AS " " (COULD USE PU2 BUT THIS FASTER)
   029	001 031		ADD T,(B)	;RQ EARLIER, ADD BACK
   030	001 031		MOVEM T,(C)	;SET DELTA OF BLOCK BEING ADDED
   031	001 031		SUB T,(B)	;COMPUTE NEG OF DELTA FOR NEXT BLOCK
   032	001 031		MOVNM T,(B)	;SET TIME DELTA FOR NEXT BLOCK
   033	001 019		MOVEM B,1(C)	;SET LINK OF NEW BLOCK TO NEXT
   034	001 020		MOVEM C,1(A)	;SET LINK OF PREV BLOCK TO NEW
   035			JRST (E)
   036		
   037		CLQPU6:	SETZM (C)	;SET TIME DELTA OF NEW BLOCK TO ZERO
   038	001 018		MOVE A,1(B)	;GET POINTER TO NEXT BLOCK
   039	001 018		MOVEM A,1(C)	;SET POINTER OF NEW TO NEXT BLOCK
   040	001 020		MOVEM C,1(B)	;SET POINT OF CURRENT TO NEW BLOCK
   041			JRST (E)î   001		                                                                      PAGE 15
   002		;MAIN PROG LEVEL ADD TO CLOCK QUEUE
   003		;CALL BY PUSHJ P,CLQADD
   004		;WITH POINTER TO BLOCK IN NEXT WORD AND TIME TILL RQ IN T IN 60'THS
   005		;POINTER TO BLOCK SHOULD NOT BE INDEXED BY C
   006		
   007	001 031	CLQAD1:	MOVEI T,1	;RQ IN ONE TICK
   008	001 020	CLQADD:	PUSH P,C
   009	001 020		MOVE C,@-1(P)	;GET BLOCK POINTER
   010	001 020		MOVEI C,@C
   011			SKIPL 1(C)	;SKIP IF IDLE
   012	057 013		JRST POPCJ1	;IGNORE THIS RQ, BLOCK ALREADY ACTIVE
   013	001 018		PUSH P,A
   014	001 019		PUSH P,B
   015	001 022		PUSH P,E
   016			SKIPN (C)	;DELTA WORD OF IDLE BLOCK SHOULD BE ZERO
   017	001 031		SKIPG T		;TIME SHOULD BE NON-ZERO
   018			JRST 4,.
   019	005 036		CONO PI,CLKOFF
   020	014 022		JSP E,CLQPUT	;ADD RQ
   021	005 035	CLQDE4:	CONO PI,CLKON
   022	001 022		POP P,E
   023	001 019		POP P,B
   024	001 018		POP P,A
   025	057 013		JRST POPCJ1
   026		
   027		;DELETE CLOCK QUEUE ENTRY
   028		;CALL BY PUSHJ P,CLQDEL WITH POINTER TO BLOCK IN NEXT WORD
   029	001 020	CLQDEL:	PUSH P,C
   030	001 020		MOVE C,@-1(P)	;GET BLOCK POINTER
   031	001 020		MOVEI C,@C
   032	005 036		CONO PI,CLKOFF
   033			SKIPGE 1(C)	;IGNORE RQ TO DELETE  IF IDLE
   034	057 029		JRST CKOCJ1
   035	001 018		PUSH P,A
   036	001 019		PUSH P,B
   037	001 022		PUSH P,E
   038	015 041		JSP E,CLQCLR
   039	015 021		JRST CLQDE4
   040		
   041	494 004	CLQCLR:	MOVEI B,CLROOT-1	;CLOCK OFF OR IN PROGRESS VERSION
   042	001 019	CLQDE2:	MOVE A,B
   043	001 019		SKIPG B,1(B)	;GET POINTER TO NEXT BLOCK
   044	009 061		BUG .,CLK QUEUE SCREWED
   045	001 020		CAME B,C	;SKIP IF FOUND BLOCK TO DELETE
   046	015 042		JRST CLQDE2
   047	001 019		SKIPG B,1(B)	;GET POINTER TO BLOCK AFTER ONE TO DELETE
   048	009 061		BUG .,CLK QUEUE SCREWED
   049	001 019		MOVEM B,1(A)	;PATCH AROUND DELETED BLOCK
   050	001 018		MOVE A,(C)
   051	001 018		ADDM A,(B)	;ADD DELTA OF DELETED BLOCK TO NEXT
   052			SETZM (C)	;CLEAR DEL
   053			SETOM 1(C)	;MARK IDLE
   054			JRST (E)î   001		                                                                      PAGE 16
   002	013 040	CLKB1:	MOVE T,CLKBRK
   003			CONSZ 200
   004	016 010		JRST CLKFO1	;FLOATING OVERFLOW ENABLED
   005		CLKFO2:	CONSZ 20	;SKIP IF AR OV INT NOT ENABLED
   006			CONSO 10	;OV ENABLED, SKIP IF OV
   007			CONSZ 270000	;NOT OV, CHECK PDL OV, MEM PROTECT, NXM
   008	016 012		JRST CLKB1C	;PDL OV, NXM, ETC
   009	013 061		JRST CLKB1D	;ONLY CLOCK BREAK, AR OV JUST ENABLED
   010		CLKFO1:	CONSO 100	;SKIP ON FLOATING OVERFLOW
   011	016 005		JRST CLKFO2	;NOT REALLY FLOATING OVERFLOW
   012	022 042	CLKB1C:	JUMPL U,CNLJL	;NULL JOB LOST
   013	001 018		MOVEI A,0	;SET UP INTERRUPT BITS FOR USER
   014			CONSZ 20	;SKIP IF OV NOT ENABLED
   015			CONSO 10	;OV ENABLED, SKIP ON OV
   016	016 018		JRST CLB1A	;NOT AROV
   017	023 019		PUSHJ P,AROV
   018		CLB1A:	CONSZ 200	;SKIP IF FL OV NOT ENABLED
   019			CONSO 100	;FL OV ENABLED, SKIP ON FL OV
   020	016 022		JRST CLB1B	;NOT FLOATING OVERFLOW
   021	023 030		PUSHJ P,ARFOV
   022		CLB1B:	CONSO 270000	;SKIP IF PDL OV, NXM, OR MEM PROTECT
   023	022 031		JRST CLB1X
   024			CONSZ 10000	;NON EX MEM
   025	024 002		PUSHJ P,MEMHNG
   026			CONSO 200000
   027	016 031		JRST CLKB1H
   028	001 018		TRO A,200000	;PDL OVFLO
   029	003 004		TLNN T,LSRMOD	;SKIP IF IN USER MODE
   030	009 061		BUG .,PDL OV IN EXEC MODE
   031		CLKB1H:	CONSO 20000	;MEM PROTECT
   032	022 030		JRST CLKB1G
   033	500 014		HLLZ D,UPGML+3(U)	;PICK UP FAULT BITS
   034	001 021		TLNE D,1000
   035	001 021		TLNN D,770	;ALL CONDITIONS WHICH ABORT INSTRUCTION
   036	022 011		JRST CLKB1J	;(PLUS PAGE NXM FOR RANDOMNESS)
   037	500 014		HLLZ T,UPGML+1(U)
   038	001 031		LSH T,5
   039	500 014		HRR T,UPGML+1(U)	;FIX UP OPC
   040	013 040		MOVEM T,CLKBRK	;RESET PC FROM OPC
   041	013 009		AOS NPGFLT
   042	500 014		HLRZ E,UPGML(U)
   043	001 022		TRNN E,400
   044	022 047		BUG CFHFPF,EXEC PG FAULTî   001		                                                                      PAGE 17
   002	001 022		ANDI E,377	;FLUSH AGE, ETC.
   003	033 054		MOVE TT,LUMPS
   004	493 027		HRRZ W,USER
   005	001 021		TLNE D,100	;ATTEMPTED WRITE INTO READ ONLY PAGE
   006	022 002		JRST CFH4
   007	033 053	CFHSW1:	HRRZM E,CFHUVP	;USER'S VIRTUAL PAGE NUMBER
   008	001 021		TLNE D,200
   009	022 002		JRST CFH4	;DBL
   010	001 022		TRZE E,200	;W 4.9 SET IF ENTERED FROM SWPPIN
   011	018 002		JRST CFH1	;VIRTUAL ADDRESS IN USER'S HIGH SEG
   012	500 044		MOVE C,UCPB1(W)
   013	001 023		TLNN TT,200000
   014	017 018		JRST CFH2	;MY LOWER DBR NOT HACKED
   015	500 044	CFH3:	MOVE C,UCPB1(TT)
   016	001 023		TLNN TT,40000
   017	500 045		MOVE C,UCPB2(TT)
   018	001 022	CFH2:	ROT E,-1
   019	001 022		ADD C,E
   020	001 020		HRLI C,222200
   021	001 022		SKIPGE E
   022	001 020		HRLI C,2200
   023	001 020		LDB E,C		;CIRC MEM USE POINTER FOR PAGE FAULT ADDRESS IS IN
   024	022 002		JUMPE E,CFH4	;REAL ILM
   025	001 022		CAIN E,-1
   026	022 002		JRST CFH4	;ON REFERENCE TO ABS PAGE ALSO ILM
   027	499 017		SKIPGE RPCL(W)
   028	021 035		JUMPGE W,CFF1	;BEING RPCLSRED?
   029	033 051		MOVEM A,CFHAS
   030	001 021		TLNE D,40
   031	018 007		JRST CFHRWF
   032	247 027	CFHRW1:	AOSE CIRPSW
   033	019 035		JRST CFH5	;NOT AVAILABLE
   034	001 022		TRZE E,400000
   035	001 022		TRNE E,200000
   036	017 045		JRST CFHSW3
   037	263 138		CAML E,MMPMX
   038			JRST 4,.	;MMP OUT OF RANGE
   039	001 022		MOVE C,E	;CIRC PNTR ALREADY POINTS TO MMP
   040	263 139		ADD C,MMPEAD
   041	001 021	CFHSW4:	LDB D,[410200,,(C)]	;TWO BITS OF MMP ENTRY GIVES DISPOSITION OF PAGE
   042	013 019		AOS NRPI(D)
   043	019 002		JRST @CFHDT(D)
   044		
   045	256 010	CFHSW3:	PUSHJ P,UCPRL	;FIND MMP
   046			200000,,.+2
   047			JRST 4,.	;NONE?
   048	001 030		SUB P,[4,,4]
   049	017 041		JRST CFHSW4î   001		                                                                      PAGE 18
   002	500 045	CFH1:	MOVE C,UCPB2(W)
   003	001 023		TLNN TT,100000
   004	017 018		JRST CFH2
   005	017 015		JRST CFH3
   006		
   007	001 021	CFHRWF:	TLNE D,10
   008	017 032		JRST CFHRW1	;SOMETIMES NO ACCESS SEEMS TO BE ON TOO
   009	500 014		HLRZ E,UPGML(W)	;ATTEMPTED WRITE IN READ/WRITE/FIRST MODE
   010	001 022		ANDI E,377
   011	500 014		HRRZ C,UPGML+4(W)
   012	001 022		TRZE E,200
   013	500 014		HRRZ C,UPGML+5(W)
   014	001 022		ROT E,-1
   015	001 022		ADD C,E
   016	001 020		HRLI C,420200
   017	001 022		SKIPGE E
   018	001 020		HRLI C,200200
   019	001 020		LDB E,C		;PAGE ENTRY PROTECTION BITS
   020	001 022		CAIE E,2
   021			JRST 4,.
   022	001 022		MOVEI E,3	;READ/WRITE
   023	001 020		DPB E,C
   024	019 030		JRST CFHX1î   001		                                                                      PAGE 19
   002	019 007	CFHDT:	CFHPI	;IN
   003	019 042		CFHPCI	;COMING IN
   004	020 002		CFHPO	;OUT
   005	019 043		CFHPGO	;GOING OUT
   006		
   007	001 020	CFHPI:	HRLI C,2200
   008	256 010		PUSHJ P,UCPRL	;PAGE REALLY IN.  JUST SET UP MAP
   009			100000,,.+2	;RETURN ON MEMPNT
   010			JRST 4,.
   011	001 030		SUB P,[4,,4]	;FIND MEMBLT INDEX
   012	001 031		MOVE E,T
   013	263 115		HLLZS MMSWP(E)	;CLEAR LENGTH OF CIRC LIST (BUT NOT EXEC PGS COUNT)
   014	256 010		PUSHJ P,UCPRL	;STORE IN ALL MAPS LINKED
   015	456 044		400000,,QSWI1	;INSERT INTO MAPS AND COUNT OF USERS IN CP LIST
   016	019 039		JUMPL W,SCRPSJ	;DONT HACK FLSINS
   017	001 020		MOVEI C,0
   018	001 018		MOVNI A,1
   019	247 027	CFHX:	SETOM CIRPSW
   020	001 028		TLNN W,200000
   021	057 006		JUMPL W,CPOPJ
   022	001 021	CFH5A:	MOVSI D,200000
   023	499 014		SKIPN FLSINS(W)
   024	500 052		IORM D,USWST(W)	;WAITING FOR PAGE
   025	499 014		SKIPN FLSINS(W)
   026	499 014		MOVEM C,FLSINS(W)
   027	499 014		SKIPE FLSINS(W)
   028	494 001		CLEARM DLSRCH
   029	057 006		JUMPL W,CPOPJ
   030	033 051	CFHX1:	MOVE A,CFHAS
   031	001 021		MOVSI D,1770	;CLEAR FAULT STATUS BITS
   032	493 027		MOVE U,USER
   033	022 028		JRST CFH6
   034		
   035	057 006	CFH5:	JUMPL W,CPOPJ
   036	247 027		MOVE C,[SKIPL CIRPSW]
   037	019 022		JRST CFH5A
   038		
   039	247 027	SCRPSJ:	SETOM CIRPSW
   040	001 030		POPJ P,
   041		
   042		CFHPCI:
   043		CFHPGO:
   044	001 021	CFHPO2:	MOVSI D,100000	;BIT ON IF PAGE "IN TRANSIT"
   045	001 018		MOVNI A,1	;SIGNAL "SUCCESS"
   046	001 028		TLNN W,200000
   047	019 039		JUMPL W,SCRPSJ
   048	499 014		SKIPN FLSINS(W)
   049	500 084		MOVEM D,EPDL2(W)	;HANG USER UNTIL PAGE GETS WHERE IT'S GOING
   050	001 031		HRLI C,(TDNE T,)	;COMBINE WITH ADDRESS OF MMP
   051	019 019		JRST CFHXî   001		                                                                      PAGE 20
   002	500 067	CFHPO:	SKIPGE USWSCD(W)
   003	021 049		JRST CFBO1	;GUY LOCKED OUT
   004	001 022	CFBO2:	MOVSI E,20000	;PAGE OUT, SWAP IN
   005	001 022		AND E,(C)
   006	005 048		CONO PI,UTCOFF
   007	020 046		JUMPN E,CFHPO5	;INITIAL SWAPIN
   008	261 040	CFHPO7:	PUSHJ P,HMRQC
   009	021 002		JRST CFHPO1	;MEM NOT AVAILABLE
   010	001 019		MOVEI B,1
   011	001 019		DPB B,[410200,,(C)]	;INDICATE COMING IN
   012	001 019		HRRZ B,(C)	;OLD CP OF MMP
   013	001 019		HLL B,1(C)	;DISK ADDRESS
   014	263 112		MOVEM B,MEMPNT(A)
   015	020 059		JUMPN E,CFHPO8	;INITIAL SWAPIN
   016	004 039	CFHPO9:	CAIGE A,TSYSM
   017	500 109		CAIGE A,SYSB
   018			JRST 4,.	;SHOULDN'T HAVE TO SWAP IN THE SYSTEM
   019	005 047		CONO PI,UTCON
   020	033 029		SOS NPGSWO
   021	497 014		AOS TSIPRQ	;TOTAL SWAP IN REQUESTS
   022	263 073		MOVEI B,MU23B
   023	263 044		DPB B,[MUR,,MEMBLT(A)]
   024	006 055		MOVEI B,NQCHN+1	;SWAPPING DISK CHANNEL
   025	263 044		DPB B,[M2311C,,MEMBLT(A)]
   026	001 019		MOVEI B,600000(A)
   027	001 019		HRRM B,(C)	;MAKE CP OF MMP POINT TO MEMPNT
   028	263 044		HRRM C,MEMBLT(A)	;STORE MMP ADDRESS IN RH OF MEMBLT
   029	005 048		CONO PI,UTCOFF
   030	263 115		HRLZM C,MMSWP(A)	;MMP ADDRESS
   031	263 115		MOVEI D,MMSWP(A)
   032	033 041		MOVE B,SILEND
   033	033 041		MOVEM D,SILEND
   034	001 021		HRRM D,(B)	;ADD TO END OF LIST
   035	033 039		AOS SILNG
   036	005 047		CONO PI,UTCON
   037	427 013		PUSHJ P,QSTRTR
   038	001 021		MOVSI D,100000
   039	001 028		TLNE W,-1
   040	500 052		ANDCAM D,USWST(W)	;SWAPPING IN A PAGE FOR THIS GUY SO CLEAR BEST EFORT MADE TO SWAP OUT BIT
   041	001 028		TLNN W,200000
   042	019 044		JUMPL W,CFHPO2
   043	499 050		AOS USIPRQ(W)
   044	019 044		JRST CFHPO2	;HANG USER UNTIL PAGE IN
   045		
   046	409 004	CFHPO5:	LDB I,[DADDNL+1(C)]	;GET DSK #
   047	004 035		CAIL I,NQS
   048			JRST 4,.
   049	448 012		SKIPL QTUTO(I)
   050	020 008		JRST CFHPO7	;DISK TUT AVAIL
   051	005 047		CONO PI,UTCON
   052	001 018		MOVEI A,0	; LOCKED
   053	001 028		TLNN W,200000	;SCHEDULER
   054	019 039		JUMPL W,SCRPSJ
   055	448 012		MOVE C,[SKIPGE QTUTO]
   056	001 024		ADD C,I
   057	019 019		JRST CFHX
   058		
   059	001 022	CFHPO8:	ANDCAM E,(C)	;CLEAR INITIAL SWAPIN BIT
   060	409 006		LDB D,[DADTNL+1(C)]	;GET TRK #
   061	409 059		IDIVI D,TUTEPW                                                PAGE 20.1
   062	448 012		ADD D,QTUTO(I)
   063	439 052		HLL D,TBTBL(E)
   064	001 021		LDB E,D
   065	409 062		CAIGE E,TUTMNY
   066	001 022		SOS E
   067	001 021		DPB E,D
   068			HRRZS 1(C)	;CLEAR ASSIGNED TRACK NUMBER SO NEW SPACE ASSIGNED ON SWAPOUT
   069	020 016		JRST CFHPO9î   001		                                                                      PAGE 21
   002	005 047	CFHPO1:	CONO PI,UTCON	;NO MEM AVAILABLE TO SWAP INTO
   003	001 018		MOVEI A,0	;INDICATE NO PROGRESS POSSIBLE
   004	001 028		TLNN W,200000	;SCHEDULER
   005	019 039		JUMPL W,SCRPSJ
   006	263 108		SKIPGE MEMFRZ
   007	021 011		JRST CFHPO4
   008	263 108		MOVE C,[SKIPL MEMFRZ]
   009	019 019		JRST CFHX
   010		
   011	021 022	CFHPO4:	MOVE C,[PUSHJ P,CFHPO3]
   012	033 040		MOVN D,SOLNG
   013	033 037		SUB D,SWPOPR	;- # PGS GOING OUT
   014	001 021		ADDI D,10.	;MAKE SURE AT LEAST 10. GOING OUT
   015	001 021		JUMPLE D,.+2
   016	033 037		ADDM D,SWPOPR
   017	001 021		MOVEI D,1
   018	499 014		SKIPN FLSINS(W)
   019	500 084		MOVEM D,EPDL2(W)
   020	019 019		JRST CFHX
   021		
   022	001 018	CFHPO3:	PUSH P,A	;FLSINS ROUTINE (NEEDED MEM)
   023	497 002		MOVE A,MEMFR
   024	497 024		SUB A,NCBCOM
   025	001 018		CAIL A,5(T)
   026	057 003		JRST POPAJ1	;NEEDED MEM AVAILABLE
   027	033 040		ADD A,SOLNG
   028	033 037		ADD A,SWPOPR
   029	001 018		SUBI A,10.(T)
   030	057 005		JUMPGE A,POPAJ	;WILL EVENTUALLY WIN
   031	001 018		MOVNS A
   032	033 037		ADDM A,SWPOPR	;LOSING - SWAP SOME MORE STUFF OUT
   033	057 005		JRST POPAJ
   034		
   035	013 040	CFF1:	MOVE C,CLKBRK
   036	003 004		TLNE C,LSRMOD
   037	493 027		BUG .,BEING RPCLSRED IN USER MODE
   038	001 021		MOVSI D,1770
   039	500 014		ANDCAM D,UPGML+3(W)
   040	500 014		LPMR UPGML(W)
   041	005 029		CONO 470000+APRCHN
   042	002 036		MOVE T,[BADBTS]
   043	499 003		IOR T,MSKST(W)
   044	001 018		AND T,A
   045	499 002		IORM T,PIRQC(W)
   046	005 036		CONO PI,CLKOFF
   047	048 032		JRST 10,UFL1
   048		
   049	497 002	CFBO1:	MOVE E,MEMFR	;GUY SWAPPED BLOCKED
   050	497 024		SUB E,NCBCOM
   051	033 057		SUB E,AUSOPG
   052	033 039		SUB E,SILNG
   053	033 040		ADD E,SOLNG
   054	021 061		JUMPGE E,CFBO3	;SEEMS TO BE ROOM SO LET IT COME IN
   055	013 015		AOS NTSBUB
   056	001 018		MOVEI A,0	;HANG GUY UNTIL SWAP BLOCK GOES AWAY
   057	500 067		MOVE C,[SKIPGE USWSCD]
   058	001 020		ADDI C,(W)
   059	019 019		JRST CFHX
   060		
   061	013 014	CFBO3:	AOS NTSBUP                                                    PAGE 21.1
   062	020 004		JRST CFBO2î   001		                                                                      PAGE 22
   002	035 017	CFH4:	JUMPL W,SWIILM
   003	013 040		AOS T,CLKBRK
   004	003 004		TLNE T,LSRMOD
   005	022 011		JRST CLKB1J
   006	062 051		MOVEI C,IOADCR	;FROM EXEC MODE SO RESET PC TO IOADCR
   007	013 040		EXCH C,CLKBRK
   008	500 026		MOVEM C,LEXFDR(U)	;AND SAVE FAULT EXEC ADR FOR DEBUGGING
   009	494 001		CLEARM DLSRCH	;IN CASE IT WAS SET
   010	500 033		CLEARM UMAPS(U)	;RESTORE NORMAL MAP IN CASE RANDOM ONE WAS IN USE
   011	500 025	CLKB1J:	MOVEM D,LPFBTS(U)	;SAVE FOR DEBUGGING PURPOSES
   012	001 021		TLZE D,210	;NO ACCESS OR DBL
   013	002 016		TRO A,BIOADC	;ILM
   014	001 021		TLZE D,20	;PURE
   015	001 018		TLO A,(BPURE)
   016	001 021		TLZE D,100	;W IN RD ONLY
   017	001 018		TLO A,(BWIRO)
   018	002 029		TDNE A,[BIOADC\BWIRO]
   019	072 058		PUSHJ P,MPVMAS	;???
   020		;NO ABORT-TYPE FAULTS, CHECK OTHERS
   021	001 021		TLZE D,2
   022	023 002		PUSHJ P,PCMARB
   023	001 021		TLZE D,2000
   024	023 009		PUSHJ P,CPROC1	;ONE PROCEED
   025	001 021		TLZ D,1	;IGNORE Q.T. INT (ONLY USED FOR RUNTIME)
   026	500 014		ANDCA D,UPGML+3(U)	;GET BITS FLUSHED BY TLZE'S
   027	001 021		TLZ D,4	;DONT CLEAR EXEC PG
   028	500 014	CFH6:	ANDCAM D,UPGML+3(U)
   029	500 014	CLKB1K:	LPMR UPGML(U)
   030	005 029	CLKB1G:	CONO 470000+APRCHN	;RESET
   031	002 036	CLB1X:	MOVE T,[BADBTS]
   032	499 003		IOR T,MSKST(U)	;GET OR OF ENABLED AND BAD BITS
   033	001 018		AND T,A		;GET AND WITH BITS ACTUALLY ON
   034	022 038		JUMPE T,CLB1XA	;NOT BAD OR ENABLED, FORGET ABOUT IT
   035	499 002		IORM T,PIRQC(U)	;BLAME IT ON THE USER
   036	029 004		JRST SCHED
   037		
   038	499 014	CLB1XA:	SKIPE FLSINS(U)
   039	029 004		JRST SCHED
   040	013 061		JRST CLKB1D
   041		
   042		CNLJL:	CONSZ 230220	;SKIP ON JUST "ADDR BREAK" (QUANTUM OVERFLOW)
   043			JRST 4,.+1	;NULL JOB LOST
   044	005 029		CONO 470000+APRCHN
   045	029 004		JRST SCHED
   046		
   047	001 021	CFHFPF:	MOVSI D,1770	;FALSE PAGE FAULT
   048	001 018		MOVEI A,0
   049	022 028		JRST CFH6
   050		
   051	010 014	EBLK
   052		RINT:	0
   053	010 022	BBLK
   054	009 061		BUG .+1,RANDOM INT
   055	022 052		JRST 12,@RINT
   056		
   057	010 014	EBLK
   058		R1NTAC:	BLOCK 20
   059		RINT1:	0
   060	010 022	BBLK
   061	022 058		MOVEM 17,R1NTAC+17                                            PAGE 22.1
   062	022 058		MOVEI 17,R1NTAC
   063	022 058		BLT 17,R1NTAC+16
   064	001 026		MOVEI J,1
   065	491 003		JSP E,SPUR
   066	022 058		MOVSI 17,R1NTAC
   067			BLT 17,17
   068	022 059		JRST 12,@RINT1î   001		                                                                      PAGE 23
   002	013 040	PCMARB:	MOVE B,CLKBRK
   003	500 004		MOVEM B,UMARPC(U)
   004	002 017		TRO A,BMARI
   005	001 019		MOVEI B,0
   006	500 014		DPB B,[220300,,UPGML+2(U)]	;DISABLE MAR
   007	001 030		POPJ P,
   008		
   009	013 040	CPROC1:	MOVE T,CLKBRK
   010	003 004		TLNN T,LSRMOD	;SKIP IF FROM USER MODE
   011	023 015		JRST CPRUUO
   012	002 014		TRO A,BPROC	;GIVE USER INTERRUPT
   013	001 030		POPJ P,
   014		
   015	042 050	CPRUUO:	MOVE T,[JRST ONEPROC]	;ONE PROCEED INT. FROM EXEC. MODE
   016	060 030		MOVEM T,UEXIT	;CLOBBER EXIT TO RUN SYS CALL TO COMPLETION
   017	001 030		POPJ P,
   018		
   019	001 031	AROV:	TLZE T,400000
   020	003 004		TLNN T,LSRMOD
   021	023 027		JRST AROV2	;NOT REALLY SET OR SET BY SYS
   022	013 040		MOVEM T,CLKBRK
   023	499 009		SKIPE PICLR(U)	;SKIP IF INTERRUPTS TO USER NOT ENABLED
   024	002 006		TRO A,AROIF	;GIVE USER INTERRUPT
   025	001 030		POPJ P,
   026		
   027	013 040	AROV2:	MOVEM T,CLKBRK
   028	001 030		POPJ P,
   029		
   030	001 031	ARFOV:	TLZE T,40000
   031	003 004		TLNN T,LSRMOD
   032	023 027		JRST AROV2
   033	013 040		MOVEM T,CLKBRK
   034	499 009		SKIPE PICLR(U)
   035	001 018		TLO A,(ARFOIF)
   036	001 030		POPJ P,
   037		
   038	493 079	CLKB1E:	SETZM PARDIE
   039			CONSO PI,200000	;GET HERE FOR MEMORY PARITY ERROR
   040	023 110		JRST CLK1F	;SPURIOUS INT
   041			CONO PI,400	;TURN OFF WORLD
   042			CONO PI,240000	;RESET
   043	001 019		MOVSI B,1
   044	493 066		TDNE B,SUPCOR
   045			JRST 4,.	;MAKING ERRORS IN REAL TIME
   046	493 066		IORM B,SUPCOR
   047	497 042		AOS PARERR
   048	013 040		MOVE T,CLKBRK
   049	497 044		MOVEM T,PARPC
   050	493 027		MOVE T,USER
   051	497 046		MOVEM T,PARUSR
   052	493 075		SPM PARPG
   053	004 021		MOVEI TT,TSYSM-1+IFN PDP6P,16.
   054	001 021		MOVEI D,0	;POINTER TO ERROR BUFFER
   055	004 039	PARFX3:	CAIL TT,TSYSM
   056	023 060		JRST PARFX7
   057	263 044		LDB T,[MUR,,MEMBLT(TT)]
   058	263 078		CAIN T,MUHOLE
   059	023 070		JRST PARFX8	;HOLE THERE
   060	001 031	PARFX7:	MOVEI T,600000(TT)
   061	463 045		DPB T,[.PAREP+EXEUMP]                                         PAGE 23.1
   062	493 075		LPMR PARPG	;SET UP TO CHECK PAGE # IN TT
   063		PARFX1:	CONO PI,200000	;CLEAR PAR ERR
   064	001 019		MOVEI B,0	;ADDRESS WITHIN PAGE
   065	001 020	PARFX5:	MOVE C,400000+PAREP*2000(B)	;REFERENCE EVERY MEMORY LOCATION
   066			CONSZ PI,200000	;PARITY ERR?
   067	023 073		JRST PARFX4	;YES
   068	001 019		CAIGE B,1777	;SKIP ON FINISHED WITH BLOCK
   069	023 065		AOJA B,PARFX5
   070	023 055	PARFX8:	SOJGE TT,PARFX3	;CHECK NEXT PAGE
   071	023 099		JRST PARFX2	;DONE
   072		
   073	001 023	PARFX4:	MOVE E,TT
   074	001 022		LSH E,10.
   075	001 019		IOR E,B	;MAKE MEM ADR
   076	496 005		MOVE A,USRHI
   077	498 005		CAIGE E,USRSTG(A)
   078	493 079		SETOM PARDIE	;PARITY ERROR IN EXEC CORE
   079	004 039		CAIL TT,TSYSM
   080	023 092		JRST PARFX6
   081	263 044		LDB T,[MUR,,MEMBLT(TT)]
   082	263 067		CAIE T,MUFR
   083	263 068		CAIN T,MUINP
   084	023 092		JRST PARFX6
   085	263 071		CAIE T,MUDISB
   086	263 072		CAIN T,MUFRT
   087	023 092		JRST PARFX6
   088	263 079		CAIN T,MUDDT
   089	023 092		JRST PARFX6
   090	023 092		SOJE T,PARFX6	;USER
   091	493 079		SETOM PARDIE	;ERR IN CRITICAL MEMORY (DISK DIR, ETC)
   092	001 020	PARFX6:	MOVEM C,400000+PAREP*2000(B)	;FIX UP MEMORY AS BEST WE CAN
   093	493 077		MOVEM C,PARCON(D)	;SAVE LOSING CONTENTS
   094	493 078		MOVEM E,PARADR(D)	;SAVE LOSING ADDRESS
   095	493 074		CAIGE D,MXPARS-1	;OVERFLOWING BUFFER?
   096	023 063		AOJA D,PARFX1	;NO
   097	023 100		JRST 4,PARFIN	;YES, WE ARE LOSING WITH INFINTE PARITY ERRORS
   098		
   099		PARFX2:
   100	001 018	PARFIN:	MOVEI A,0
   101	463 045		DPB A,[.PAREP+EXEUMP]
   102	493 075		LPMR PARPG	;SET UP MAP
   103	493 076		MOVEM D,PARCNT	;SAVE AWAY COUNT OF ERRORS IN BUFFER
   104	493 079		SKIPE PARDIE
   105			JRST 4,.	;FATAL ERROR (DONT ALLOW CONTINUE SINCE ERR IS KNOW TO BE A LOSER)
   106			CONO PI,200	;TURN WORLD BACK ON
   107	029 004		JRST SCHED
   108		
   109		
   110		CLK1F:;	MOVEI J,APRCHN	;DO NOT TAKE THESE OUT WITHOUT SEEING RG!!!!
   111		;	JSP E,SPUR
   112	029 004		JRST SCHED
   113		î   001		                                                                      PAGE 24
   002		MEMHNG:
   003	004 021	IFN PDP6P,[
   004	500 014		LDB B,[221100,,UPGML(U)]	;FAULT ADDR
   005	001 019		TRZE B,400
   006	024 026		JRST MEMHN1
   007	500 042		HRRZ C,UDBR1(U)
   008	001 019		TRZE B,200
   009	500 043		HRRZ C,UDBR2(U)
   010	001 019		ROT B,-1
   011	001 020		ADDI C,(B)
   012	001 020		HRLI C,221100
   013	001 019		SKIPGE B
   014	001 020		HRLI C,1100
   015	001 019		LDB C,B
   016	005 067		CAIGE C,PDP6BM_-10.
   017	024 026		JRST MEMHN1
   018	013 040		MOVE B,CLKBRK
   019	003 004		TLNE B,LSRMOD
   020	024 038		JRST MEMHN3	;USER MODE PDP6 NXM
   021	001 019		MOVEI B,IOCER3	;PDP6 MEM
   022	013 040		HRRM B,CLKBRK
   023	024 027		JRST MEMHN2
   024		]
   025		
   026	009 061	MEMHN1:	BUG .+1,NXM
   027	005 029	MEMHN2:	CONO 10000+APRCHN	;CLEAR NON EX MEM AFTER HALT TO RESET MEMORY
   028	001 019		MOVSI B,4
   029	493 066		IORM B,SUPCOR
   030	013 040		MOVE T,CLKBRK
   031	497 045		MOVEM T,NXMPC
   032	493 027		MOVE T,USER
   033	497 047		MOVEM T,NXMUSR
   034	497 043		AOS NXMERR
   035	001 030		POPJ P,
   036		
   037	004 021	IFN PDP6P,[
   038	002 016	MEMHN3:	MOVSI B,BIOADC	;GIVE MPV INTERRUPT
   039	499 002		IORM B,PIRQC(U)
   040	024 027		JRST MEMHN2
   041		]î   001		;                                                                     PAGE 25
   002		; SLOW CLOCK SERVICE ROUTINE
   003		;
   004		SSLCK:
   005	004 025	IFN DPKPP,[
   006	006 023		CONSO DPK,7
   007	005 017		CONO DPK,TTYCHN	;CROCK
   008		]
   009	354 048		MOVE A,UTTBF
   010	001 018		CAIGE A,30
   011	025 014		JRST SSLCK2
   012	494 046		SETOM UTBFLF	;SIGNAL CORE JOB TO FLUSH UTAPE BUFFERS
   013	497 023		AOS NCORRQ
   014	494 029	SSLCK2:	SKIPE UTTYCT	;SKIP IF NO NEW USERS
   015	043 005		PUSHJ P,USTART	;NEW USER TO START
   016	004 004	IFN 340P,[
   017	291 075		SKIPL T,DWDS
   018	001 031		MOVEI T,0
   019	006 073		ADDI T,MDISWD
   020	291 075		MOVEM T,DWDS	;RESET DISPLAY RATE COUNTER
   021		]
   022	004 007	IFE NEWDTP,[
   023	497 003		MOVE T,TIME
   024	356 005		AOSN UIDLE	;SKIP IF DEC TAPE NOT IDLE
   025	026 024		JRST SSLCK4	;DEC TAPE IDLE
   026	356 026		SUB T,LUTOTM	;SUBTRACT LAST UTC OPERATION TIME
   027			CONSO UTC,4000
   028	003 032		CAIGE T,MXOPT*SCLKI	;SKIP IF DEC TAPE HUNG TOO LONG ON ONE OPERATION
   029	025 032		JRST SSLCK3	;OK
   030	356 027		SETOM UTHERR	;SET UTC HUNG ERR FLAG
   031	005 065	SSLCK1:	CONO UTC,CUINT	;CAUSE DEC TAPE INTERRUPT ROUTINE TO RUN
   032		SSLCK3:
   033		]
   034	005 048		CONO PI,UTCOFF
   035	004 007	IFN NEWDTP,[
   036	497 003		MOVE T,TIME
   037	356 005		AOSN UIDLE
   038	026 024		JRST SSLCK4
   039	356 026		SUB T,LUTOTM
   040	003 032		CAIGE T,MXOPT*SCLKI
   041	025 032		JRST SSLCK3
   042	356 027		SETOM UTHERR
   043	005 065	SSLCK1:	SETOM CUINT
   044	005 013		CONO PI,4000+1_<7-UTCCHN>
   045		SSLCK3:
   046		]
   047	004 008	IFN DECDKC,[
   048	449 080		SETOM QGTBZY
   049	005 014		CONO PI,4000+1_<7-DSKCHN>
   050		]
   051	005 014	IFE DECDKC,	CONO DC0,DCSET+DCIENB+DSKCHN	;ACTIVATE IDLE
   052	001 030	IFN NMTCS,	PUSHJ P,MSMAGC
   053	005 047		CONO PI,UTCON
   054	449 032		AOS QACTTM
   055	033 037	SSKQ1:	SKIPE SWPOPR
   056	025 061		JRST SSKQ2
   057	263 039		MOVN A,LMEMFR
   058	001 018		ADDI A,10.
   059	001 018		SKIPLE A
   060	033 037		ADDM A,SWPOPR	;INADEQUATE SPACE IN LOW HALF, SWAP OUT TO MAKE ROOM
   061		SSKQ2:                                                                PAGE 25.1
   062	004 004	IFN 340P,[
   063	496 010		SKIPL DISUSR
   064	027 003		PUSHJ P,DISCHK	;CHECK FOR 340 DEATH
   065		]
   066	126 004		PUSHJ P,PDCCHK	;CHECK ON REAL-TIME HACKS
   067	340 027		PUSHJ P,PTRCHK	;CHECK ON PAPER TAPE READER
   068	336 021		PUSHJ P,PTPCHK	;CHECK ON PAPER TAPE PUNCH
   069	488 083		SKIPN CCSDEV
   070	025 082		JRST SCDCK3
   071	488 083		SETZM CCSDEV
   072	001 024		MOVSI I,-128.
   073	488 080	SCDCK1:	SKIPGE A,DCHNTC(I)
   074	001 018		TLNE A,300000
   075	025 081		JRST SCDCK2
   076	488 083		AOS CCSDEV
   077	001 018		SUB A,[1,,]
   078	001 018		TLNN A,777
   079	001 018		TLZ A,400000
   080	488 080		MOVEM A,DCHNTC(I)
   081	025 073	SCDCK2:	AOBJN I,SCDCK1
   082		SCDCK3:;	JSP E,CHECK	;CHECK FOR CLOBBERED DEVICES
   083	004 021	IFN PDP6P,[
   084	496 058		SKIPL PDPISR
   085	005 022		CONO DSDEV,DSDCHN	;ENABLE INTERRUPTS FROM 6
   086		]
   087	004 026	IFN NETP,[
   088	006 026		CONI IMP,IMPCNI	;KEEPS HOST READY ON
   089	001 030		PUSHJ P,IMPOST	;START UP OUTPUT
   090			SKIPLE IMNCS
   091	001 030		PUSHJ P,IMPCCL	;CLOSE NETWORK CHANNELS
   092		]
   093	001 018		MOVE E,[ALCR1,,A]
   094	001 022		BLT E,E
   095	214 011		MOVSI U,-NCT
   096	001 018		JRST A
   097	497 005	ALCR1:	MOVN T,USRRCE(U)	;A
   098	001 031		ASH T,-4		;B
   099	497 005		ADDM T,USRRCE(U)	;C
   100	001 018		AOBJN U,A		;D
   101			JRST .+1		;E
   102	214 011		MOVN T,USRRCE+NCT
   103	001 031		ASH T,-4-2	;DISOWNED JOBS
   104	214 011		ADDM T,USRRCE+NCT
   105	214 011		MOVN T,USRRCE+NCT+1
   106	001 031		ASH T,-4+1	;SYS AND CORE JOBS
   107	214 011		ADDM T,USRRCE+NCT+1
   108	001 031		MOVEI T,0
   109	001 018		MOVE W,[ALCR4,,A]
   110	001 028		BLT W,W
   111	001 018		JRST A
   112	499 052	ALCR4:	MOVN H,JTMU(T)	;A
   113	001 029		ASH H,-4
   114	499 052		ADDM H,JTMU(T)
   115	499 003		MOVE H,MSKST(T)
   116	002 015		ANDI H,BSCLK	;E
   117	499 020		SKIPE UNAME(T)	;TT
   118	499 002		IORM H,PIRQC(T)	;I
   119	500 105		ADDI T,LUBLK	;Q
   120	496 005		CAMGE T,USRHI	;J
   121	001 018		JRST A	;R                                                    PAGE 25.2
   122			JRST .+1	;Wî   001		                                                                      PAGE 26
   002			SKIPGE 37	;CHECK FOR PLANNED SYSTEM DEATH
   003	027 017		PUSHJ P,DEATH	;ABOUT TO START DYING
   004			JFCL
   005	003 032		MOVEI T,SCLKI
   006	494 005		MOVEI C,SSLCKB
   007	014 017		JRST CLQREE	;RE-ENTER RQ FOR SLOW CLOCK BREAK
   008		
   009	001 031	VSSLCK:	MOVSI T,100
   010	493 066		IORM T,SUPCOR	;CAUSE VERY SLOW CLOCK TO RUN
   011	003 033		MOVEI T,VSCLKI
   012	494 011		MOVEI C,VSLCKB
   013	014 017		JRST CLQREE
   014		
   015	004 027	IFN CCLKP,[
   016	001 031	RCCLK:	DATAI 374,T	;HACK CHESS CLOCK
   017	001 031		TRNE T,4000
   018	494 021		AOSA CCLK1
   019	494 022		AOS CCLK2
   020	001 031		MOVEI T,6
   021	494 018		MOVEI C,CCLKB
   022	014 017		JRST CLQREE
   023		]
   024	356 026	SSLCK4:	MOVEM T,LUTOTM
   025	025 031		JRST SSLCK1î   001	004 004	IFN 340P,[                                                            PAGE 27
   002		
   003	291 035	DISCHK:	SKIPGE DISOFF
   004	001 030		POPJ P,
   005	291 070		AOSLE DISDIE
   006	260 020		SKIPGE CDISOFF
   007	001 030		POPJ P,
   008	001 031		MOVEI T,1
   009	291 036		MOVEM T,DTIME
   010	274 131	DISZAP:	MOVEI T,DIS300-1	;CAUSE 340 TO STOP AND INTERRUPT SOON
   011	291 066		MOVEM T,DBLKOP
   012	291 035		CLEARM DISOFF
   013	005 027		CONO DIS,5100+SDCHN_3+DISCHN
   014	001 030		POPJ P,
   015		]
   016		
   017	494 067	DEATH:	SKIPL SHUTLK
   018	001 030		POPJ P,
   019			SETZM 37	;CLEAR START DYING FLAG
   020	001 031		MOVEI T,60.*5.*60.	;5 MIN
   021	497 016		MOVEM T,DEDTIM
   022	001 031		LSH T,-1
   023	497 003		ADD T,TIME
   024	497 015		MOVEM T,SHUTDN
   025	015 029		PUSHJ P,CLQDEL
   026	497 019		 DEDBLK
   027	497 016	DEATHX:	SKIPN T,DEDTIM
   028	001 030		POPJ P,
   029			AOS (P)
   030	001 023		MOVEI TT,0
   031	001 031		CAIGE T,40.*60.
   032	027 035		JRST DEATHY
   033	001 031		MOVE TT,T
   034	001 023		LSH TT,-2
   035	497 016	DEATHY:	MOVEM TT,DEDTIM
   036	001 023		SUB T,TT
   037	015 008		PUSHJ P,CLQADD
   038	497 019		 DEDBLK
   039	002 009	DEATHM:	MOVEI A,BSYSDN
   040	040 030		PUSHJ P,INTALL	;TELL THE WORLD
   041	001 031		MOVSI T,200000	;CAUSE TYPE OUT ON UNLOGGED-IN CONSOLES
   042	493 066	SUPSET:	IORM T,SUPCOR
   043	001 030		POPJ P,
   044		
   045		;15 SECOND CLOCK
   046		15SCLK:
   047	001 030	IFN NETP,	PUSHJ P,IMRSTO	;RESET CONTROL LINK RFNM WAIT FOR LOSING IMP.
   048	001 019		MOVSI B,100000	;SET UP TO CLEAR "BEST EFFORT TO SWAP OUT BIT"
   049	033 059		CLEARB T,NUSWB	;# USERS LOCKED OUT
   050	033 060		SETOM BUSR	;SMALLEST SWAPPED BLOCKED USER
   051	033 061		SETZM BUSIZ	;SIZE OF SMALLEST SWAPPED BLOCKED USER
   052	033 062		CLEARM ASBUM	;REAL MEM OCC BY ACTIVE SWAPPED BLOCKED LOSERS
   053	001 021		MOVSI D,400000	;TO CLEAR SWAPPED BLOCKED BIT
   054	496 005	15S1:	CAML T,USRHI
   055	027 070		JRST 15S2
   056	499 020		SKIPN UNAME(T)
   057	027 067		JRST 15S3
   058	500 068		MOVN C,USWPRI(T)
   059	001 020		ASH C,-2
   060	500 068		ADDM C,USWPRI(T)	;DECAY JOB SWAP PRI'S
   061	500 050		MOVE C,NMPGS(T)                                               PAGE 27.1
   062	001 020		SUBI C,1	;COMPENSATE FOR PAGE ZERO ALWAYS IN
   063	500 062		CAMLE C,NSWPGS(T)	;SKIP ON NOT COMPLETELY OUT
   064	500 052		ANDCAM B,USWST(T)
   065	500 067		SKIPGE USWSCD(T)
   066	027 080		JRST 15S4	;CLEAR SWAPPED BLOCK BIT AND MAYBE ADD TO AUSOPG AND TRUMM (IF HE WAS HUNG ON IT)
   067	500 105	15S3:	ADDI T,LUBLK
   068	027 054		JRST 15S1
   069		
   070	028 001	15S2:	PUSHJ P,SWSCD	;SWAP BLOCK LOSERS IF NECESSARY
   071	214 011		MOVSI T,-NCT-2
   072	497 013	15S5:	MOVN C,SWRCE(T)	;DECAY TREE SWAP PRI'S
   073	001 020		ASH C,-2
   074	497 013		ADDM C,SWRCE(T)
   075	027 072		AOBJN T,15S5
   076	001 031		MOVEI T,15.*60.
   077	494 008		MOVEI C,15SCLB
   078	014 017		JRST CLQREE
   079		
   080	500 067	15S4:	ANDCAM D,USWSCD(T)	;CLEAR SWAP BLOCK BIT
   081	499 014		SKIPN TT,FLSINS(T)	;WAS HE HUNG TESTING IT
   082	027 067		JRST 15S3
   083	001 023		SUBI TT,(T)
   084	500 067		CAME TT,[SKIPGE USWSCD]
   085	027 067		JRST 15S3	;HE WASN'T HUNG ON THIS
   086	499 014		CLEARM FLSINS(T)	;HE WAS SO NOW HES ACTIVE
   087	500 050		MOVE TT,NMPGS(T)
   088	033 056		ADDM TT,TRUMM	;GUY IS NOW RUNNABLE
   089	500 062		SUB TT,NSWPGS(T)	;ANY PAGES HE MAY HAVE IN MEM NO LONGER BELONG TO A BLOCKED USER
   090	001 023		MOVNS TT
   091	033 058		ADDB TT,BUMPGS
   092	001 023		SKIPGE TT
   093	033 058		CLEARB TT,BUMPGS
   094	500 062		MOVE TT,NSWPGS(T)	;ANY SWAPPED OUT PAGES BELONG TO AN ACTIVE USER
   095	033 057		ADDM TT,AUSOPG
   096	027 067		JRST 15S3î   001	033 056	SWSCD:	MOVE E,TRUMM	;SEE IF NECESSARY TO SWAP BLOCK SOMEONE       PAGE 28
   002	500 109		CAIGE E,SYSUSM-SYSB-40
   003	001 030		POPJ P,	;NO SHOULD FIT
   004	497 002		MOVE E,MEMFR
   005	497 024		SUB E,NCBCOM
   006	033 040		ADD E,SOLNG
   007	033 039		SUB E,SILNG
   008	033 057		SUB E,AUSOPG
   009	033 058		ADD E,BUMPGS	;WILL SWAP OUT BLOCKED USERS FIRST
   010	033 062		ADD E,ASBUM
   011	001 022		SUBI E,20	;SLOP
   012	057 006		JUMPGE E,CPOPJ	;SHOULD HAVE ROOM FOR EVERYBODY
   013	033 063		MOVMM E,SWSCT1	;SAVE # PGS REQ
   014	001 022		MOVNI E,1	;NEED TO GRONK USER (MAYBE)
   015	001 023		CLEARB T,TT	;TT SWP PRI OF PROCESS
   016	001 027		MOVEI R,0	;R SWP PRI OF TREE
   017	496 005	SWSCP1:	CAML T,USRHI
   018	028 044		JRST SWSCP2
   019	499 020		SKIPE UNAME(T)
   020	498 053		SKIPE USTP(T)
   021	028 030		JRST SWSCP7
   022	500 067		SKIPGE USWSCD(T)
   023	028 030		JRST SWSCP7	;GUY ALREADY LOCKED OUT
   024	499 014		SKIPE FLSINS(T)
   025	028 038		JRST SWSCP4	;SEE IF REALLY BLOCKED OR JUST PAGE WAIT
   026	499 051	SWSCP5:	MOVE B,UTMPTR(T)
   027	497 005		CAML R,SWRCE-USRRCE(B)
   028	500 068		CAMG TT,USWPRI(T)
   029	028 033		JRST SWSCP6	;THIS GUY A BIGGER LOSER THAT PREV BIGGEST
   030	500 105	SWSCP7:	ADDI T,LUBLK
   031	028 017		JRST SWSCP1
   032		
   033	001 031	SWSCP6:	MOVE E,T
   034	497 005		MOVE R,SWRCE-USRRCE(B)
   035	500 068		MOVE TT,USWPRI(T)
   036	028 030		JRST SWSCP7	;GUY REALLY BLOCKED
   037		
   038	500 052	SWSCP4:	MOVE B,USWST(T)
   039	001 019		TLNE B,200000
   040	028 026		JRST SWSCP5
   041	028 030		JRST SWSCP7
   042		
   043		
   044	057 006	SWSCP2:	JUMPL E,CPOPJ	;NO VICTIM
   045	500 050		MOVE B,NMPGS(E)
   046	500 109		CAIGE B,SYSUSM-SYSB-30
   047	028 051		JRST SWSCP9	;"SMALL LOSER"
   048	500 062		SUB B,NSWPGS(E)
   049	033 063		CAMLE B,SWSCT1	;SKIP ON WILL STILL NEED TO BLOCK MORE LOSERS
   050	001 030		POPJ P,
   051	001 019	SWSCP9:	MOVSI B,400000
   052	500 067		IORM B,USWSCD(E)	;SWAP BLOCK LOSER
   053	033 059		AOS NUSWB
   054	013 013		AOS NTUSB
   055	500 050		MOVE TT,NMPGS(E)
   056	033 061		CAMLE TT,BUSIZ
   057	028 060		JRST SWSCP8
   058	033 061		MOVEM TT,BUSIZ
   059	033 060		MOVEM E,BUSR
   060	500 062	SWSCP8:	SUB TT,NSWPGS(E)
   061	001 023		SOSGE TT                                                      PAGE 28.1
   062	001 023		MOVEI TT,0
   063	033 062		ADDM TT,ASBUM	;THIS GUY SWAPPED BLOCKED
   064	500 050		MOVN TT,NMPGS(E)
   065	033 056		ADDM TT,TRUMM	;DOESNT COUNT ANY MORE
   066	033 056		SKIPGE TRUMM
   067	033 056		CLEARM TRUMM
   068	500 062		MOVN TT,NSWPGS(E)
   069	033 057		ADDM TT,AUSOPG	;NOT REALLY ACTIVE ANY MORE
   070	028 001		JRST SWSCD	;SEE IF THATS ENUFî   001		;                                                                     PAGE 29
   002		; USER SCHEDULER
   003		;
   004	493 027	SCHED:	SKIPGE U,USER
   005	029 028		JRST SEARL0	;NULL JOB
   006	013 040		MOVE T,CLKBRK
   007	498 016		MOVEM T,UPC(U)
   008	013 002	SCHED2:	AOS NSKED
   009	060 030		MOVSI T,UEXIT	;GET HERE FROM CLUFLS
   010	498 034		HRRI T,UUO(U)
   011	060 030		BLT T,UUO+UUOH-UEXIT(U)
   012	500 014		LDB A,[2300,,UPGML+3(U)]
   013	001 018		LSH A,-2	;CONVERT TO 4 USEC INTERVAL
   014	499 049		ADDM A,UTRNTM(U)	;INCREASE RUN TIME
   015	001 018		ADDI A,250.	;ACCOUNT FOR OVERHEAD IN STARTING UP
   016	499 052		ADDM A,JTMU(U)	;DECREASE PROCEDURE PRIORITY
   017	499 051		ADDM A,@UTMPTR(U)	;DECREASE PROCEDURE TREE PRIORITY
   018	500 050		MOVE T,NMPGS(U)
   019	500 062		SUB T,NSWPGS(U)
   020	001 018		IMUL T,A
   021	499 051		MOVE Q,UTMPTR(U)
   022	500 068		ADDM T,USWPRI(U)	;CHARGE AGAINST SWAPPINNG PRI
   023	497 005		ADDM T,SWRCE-USRRCE(Q)	;AND FOR TREE
   024	500 013		SKIPL Q,RTIMER(U)	;SKIP UNLESS RUNTIME INT ACTIVE
   025	029 046		JRST SEARRT
   026	494 001	SCHED3:	SKIPGE DLSRCH
   027	037 027		JRST SEAREP	;DELETE SEARCH, EXIT
   028	033 056	SEARL0:	CLEARM TRUMM	;TOTAL RUNNABLE USER MEM
   029	033 057		CLEARM AUSOPG	;ACTIVE USER SWAPPED OUT PAGES
   030	033 058		CLEARM BUMPGS	;PAGES IN REAL CORE BELONGING TO BLOCKED USERS
   031	033 062		CLEARM ASBUM	;PGS IN REAL MEM OCC BY SWAPPED BLOCKED LOSERS
   032	033 050		SKIPL A,SWOUPG
   033	032 022		PUSHJ P,SWPUP
   034	033 038		SKIPN SWPOPB
   035	033 037		SKIPE SWPOPR
   036	031 003		PUSHJ P,SWPON	;SWAP OUT STUFF
   037	006 077	IFN NSWPV,[
   038	247 027		SKIPGE CIRPSW
   039	035 003		PUSHJ P,SWPPIN	;SERVICE SWAPPING VARIABLES
   040		]
   041	001 026		SETZB U,J	;JOB BEING SCHEDULED
   042	001 024		SETOM I		;BEST USER SO FAR
   043	497 007		SETZM RNABLU	;NUM RUNABLE USERS
   044	029 058		JRST SEARL1
   045		
   046	001 018	SEARRT:	SUB Q,A
   047	500 013		MOVEM Q,RTIMER(U)
   048	029 026		JUMPGE Q,SCHED3
   049	001 031		MOVSI T,(BRTIME)	;GIVE RUNTIME INTERRUPT
   050	499 002		IORM T,PIRQC(U)
   051	029 026		JRST SCHED3
   052		
   053		;MAIN SEARCH LOOP, RETURN HERE TO EXAMINE NEXT PROCEDURE
   054	500 105	SEARL:	MOVEI U,LUBLK	;LENGTH OF USER VAR BLOCK
   055	001 026		ADDB U,J	;STEP TO NEXT USER
   056	496 005		CAML U,USRHI	;SKIP IF EXISTS
   057	037 003		JRST SEAREN	;ALL PROCEDURES HAVE BEEN EXAMINED
   058	498 053	SEARL1:	SKIPE T,USTP(U)
   059	030 072		JRST SEARS1	;EMPTY OR STOPPED JOB SLOT
   060	499 002		SKIPE A,PIRQC(U)
   061	036 037		JRST SEAR2A	;FIRST WORD INTERRUPT PENDING                 PAGE 29.1
   062	499 004	SEARL2:	SKIPE T,IFPIR(U)
   063	039 003		JRST SEAR2B	;SECOND WORD INTERRUPT PENDING
   064	499 014	SEARL3:	SKIPN FLSINS(U)
   065	030 002		JRST SEARC	;NOT BLOCKED
   066	500 084	SEARL4:	MOVE T,EPDL2(U)
   067	499 014		XCT FLSINS(U)	;TEST BLOCKING CONDITION (MAY SKIP ONCE OR TWICE)
   068	030 052		JRST SEARLB	;UNRUNABLE
   069	030 002		JRST SEARC	;LOW PRIORITY UNBLOCK
   070	001 025		SKIPA Q,[-1]	;HIGH PRIORITY UNBLOCK
   071	001 025		MOVEI Q,3	;EXTRA LOW PRIORITY
   072	030 008		JRST SEARC2î   001		                                                                      PAGE 30
   002	001 025	SEARC:	SETZM Q		;SET TO NORMAL PRIORITY
   003	036 016		PUSHJ P,UPRIVL
   004	030 008		SOJA Q,SEARC2
   005	030 008		JRST SEARC2
   006	498 043		SKIPGE APRC(U)
   007	001 025		ADDI Q,2	;DISOWNED
   008	497 007	SEARC2:	AOS RNABLU	;ANOTHER RUNABLE USER
   009	497 003		MOVE T,TIME
   010	500 061		MOVEM T,LUBTM(U)	;RECORD LAST TIME UNBLOCKED
   011	500 067		SKIPGE USWSCD(U)
   012	030 045		JRST SEARC7	;HE'S SWAPPED BLOCKED SO HE DOESNT COUNT
   013	001 031		MOVSI T,400000
   014	500 052		ANDCAM T,USWST(U)	;RUNNABLE SO NOT DESIRED OUT
   015	500 050		MOVE T,NMPGS(U)
   016	033 056		ADDM T,TRUMM	;TOTAL RUNNABLE USER MEM
   017	500 062		MOVE T,NSWPGS(U)
   018	033 057		ADDM T,AUSOPG	;TOTAL PAGES OF RUNNABLE USERS SWAPPED OUT
   019	497 051	SEARC4:	CAMN U,UREALT
   020	030 042		JRST SEARP2	;JUMP IF SCHEDULING REAL TIME USER IN HIGH PRIORITY PHASE
   021	030 024		JUMPL I,SEARC5
   022	497 051		CAMN I,UREALT
   023	029 054		JRST SEARL	;JUMP IF REAL TIME USER SCHEDULED
   024	500 010	SEARC5:	SKIPLE T,URTIME(U)	;NON SKIP IF POSSIBLE REAL TIME BLOCK
   025	001 031		TLNN T,1	;SKIP IF REAL TIME BLOCK UNLESS PI IN PROGRESS
   026	030 029		JRST SEARC6
   027	499 009		SKIPGE PICLR(U)	;SKIP IF PI IN PROGRESS
   028	029 054		JRST SEARL	;REAL TIME BLOCKED
   029	499 051	SEARC6:	MOVE T,@UTMPTR(U)	;GET AMOUNT OF MACHINE TIME USED RECENTLY BY TREE PROCEDURE IS IN
   030	001 031		ASH T,(Q)	;LARGER C(T)= LOWER PRIORITY; INCREASE PRIORITY IF Q INDICATES
   031	040 002		JUMPL I,SEARP1	;FIRST NON-NULL JOB
   032	493 024		CAMG T,U0P
   033	040 009		JRST SEARP3	;JUMP IF USER BEING CONSIDERED HAS LOWER USRRCE (HIGHER PRIORITY)
   034	499 052		MOVE A,JTMU(U)	;USER HAS LESS PRIORITY, BUT MAY RUN ANYWAY IF JTMU'S DIFFER BY ENUF
   035	001 018		ASH A,3(Q)	;MULTIPLY BY 8+Q
   036	493 025		CAML A,U0PP	;DOES JOB HAVE LESS THAN 1/8 OF BEST SO FAR MACHINE TIME?
   037	029 054		JRST SEARL	;DOESNT MAKE IT
   038	499 052	SEARP5:	MOVE A,JTMU(U)
   039	001 018		ASH A,(Q)
   040	493 024		MOVEM T,U0P	;STORE TIME USED RECENTLY BY TREE
   041	493 025		MOVEM A,U0PP	; " BY PROCEDURE
   042	001 024	SEARP2:	MOVEM U,I	;NEW BEST USER SO FAR
   043	029 054		JRST SEARL	;TRY NEXT
   044		
   045	500 050	SEARC7:	MOVE T,NMPGS(U)	;RUNNABLE AND SWAPPED BLOCKED
   046	500 062		SUB T,NSWPGS(U)
   047	001 031		SOSGE T
   048	001 031		MOVEI T,0
   049	033 062		ADDM T,ASBUM
   050	030 019		JRST SEARC4
   051		
   052	029 054	SEARLB:	JUMPE U,SEARL	;DON'T FIGURE SYSTEM JOB
   053	500 052		MOVE T,USWST(U)
   054	500 067		SKIPL USWSCD(U)	;IF LOCKED OUT, DONT COUNT
   055	001 031		TLNN T,200000
   056	030 063		JRST SEARB1	;NOT WAITING FOR PAGE
   057	500 050		MOVE T,NMPGS(U)	;USER IS WAITING FOR PAGE SO COUNT FOR ACTIVE
   058	033 056		ADDM T,TRUMM
   059	500 062		MOVE T,NSWPGS(U)
   060	033 057		ADDM T,AUSOPG
   061	029 054		JRST SEARL                                                    PAGE 30.1
   062		
   063	001 031	SEARB1:	TLNE T,100000
   064	029 054		JRST SEARL	;HAVE MADE BEST SWAPOUT EFFORT
   065	500 050		MOVE T,NMPGS(U)
   066	500 062		SUB T,NSWPGS(U)
   067	001 031		SOSGE T
   068	001 031		MOVEI T,0
   069	033 058		ADDM T,BUMPGS	;REAL MEM PGS BELONGING TO BLOCKED USERS
   070	029 054		JRST SEARL
   071		
   072	499 020	SEARS1:	SKIPN UNAME(U)
   073	029 054		JRST SEARL
   074	500 052		MOVE T,USWST(U)	;GUY STOPPED, DOES HE HAVE PAGES IN REAL MEM?
   075	001 031		TLNE T,100000
   076	029 054		JRST SEARL	;HAVE TRIED BEST EFFORT TO SWAP OUT
   077	500 050		MOVE T,NMPGS(U)
   078	500 062		SUB T,NSWPGS(U)
   079	033 058		ADDM T,BUMPGS
   080	029 054		JRST SEARLî   001		                                                                      PAGE 31
   002		;SWAP OUT N PAGES (IN SWPOPR)
   003	033 040	SWPON:	MOVE C,SOLNG
   004	247 027		SKIPGE CIRPSW	;CAN'T DO ANYTHING WITHOUT CIRPSW
   005	001 020		CAIL C,3
   006	001 030		POPJ P,	;ALREADY STUFF ON WAY OUT
   007	033 031		MOVE C,PSWCLS
   008	033 030		SKIPL U,PSWOUS
   009	496 005		CAML U,USRHI
   010	031 013		JRST SWPON1
   011	499 020		SKIPE UNAME(U)	;SKIP ON USER KILLED
   012	500 052		SKIPL USWST(U)
   013	032 039	SWPON1:	PUSHJ P,SWPON2	;FIND NEW USER TO FLUSH
   014	032 018		JUMPL U,SWUP8
   015	001 018		MOVSI A,(SETZ)
   016	500 052		IORM A,USWST(U)
   017	033 031		MOVEM C,PSWCLS
   018	033 030		MOVEM U,PSWOUS
   019	498 016		MOVE T,UPC(U)
   020	003 004		TLNE T,LSRMOD
   021	031 028		JRST SWPU1	;OK TO SWAP USER
   022	499 014		SKIPE FLSINS(U)
   023	031 090		JRST SWPU1A
   024	041 021		PUSHJ P,PCLSR
   025	001 030		POPJ P,
   026		;		DROPS THROUGH
   027		
   028	013 006	SWPU1:	AOS NSOUSR
   029	001 018		TLO A,40000
   030	001 020		CAILE C,1	;CLASS
   031	500 052		IORM A,USWST(U)	;INDICATE USER WAS RUNNABLE AT TIME OF SWAP OUT
   032	033 035		MOVE B,PSWLC
   033	033 032		AOSE PSWSFL
   034	031 073		JRST SWPU3A	;PICK UP FROM WHERE LEFT OFF
   035	500 042		MOVE C,UDBR1(U)	;ADDRESS OF PAGE MAP (START FROM PG 0)
   036	500 051		LDB B,[2300,,HUSRAD(U)]	;CAN BE GREATER THAN RANGE OF DBR1 BUT WILL BE LIMITED BY DBL
   037	500 044		MOVE J,UCPB1(U)
   038	033 036		SETOM SWPP0F
   039	001 019	SWPU7C:	ASH B,-10.	;SAVE SIGN BIT
   040	001 020		LDB T,[230700,,C]	;GET DBL
   041	001 031		LSH T,1	;2 PGS / WD
   042	001 031		CAIGE T,(B)
   043	001 031		HRR B,T	;MIN HUSRAD/2000, 2*DBL
   044	001 019		TRNN B,-1
   045	031 075		JRST SWPU7B	;NO PGS THIS DBR
   046	001 026		HRLI J,442200
   047	001 020		HRLI C,442200	;CNVRT TO BYTE PNTR TO MAP
   048	033 033		MOVEM C,SWPMBP
   049	033 034		MOVEM J,SWPCBP
   050	033 034	SWPU2:	ILDB D,SWPCBP	;CIRC PNTR ENTRY
   051	033 033		ILDB A,SWPMBP	;PAGE MAP ENTRY
   052	013 007		AOS NSOPGS
   053	033 035		MOVEM B,PSWLC
   054	031 073		JUMPE D,SWPU3A	;DOESN'T HAVE PAGE
   055	033 036		AOSN SWPP0F
   056	498 053		SKIPE USTP(U)	;DON'T SWAP OUT PAGE 0 IF NOT STOPPED
   057	001 021		CAIN D,-1
   058	031 073		JRST SWPU3A	;PAGE IS ABSOLUTE
   059	001 018		TRNN A,600000
   060	031 073		JRST SWPU3A	;NO ACCESS
   061	001 018		ANDI A,777	;PAGE NUMBER                                  PAGE 31.1
   062	263 115		HRRZ D,MMSWP(A)	;NUMBER OF USERS WHO HAVE THIS PAGE
   063	032 002		SOJN D,SWPU4	;PAGE IS SHARED
   064	033 030	SWPU6:	MOVE C,PSWOUS
   065	034 002		PUSHJ P,SWPOPG
   066	031 071		JRST SWPU3
   067	033 040		MOVE C,SOLNG
   068	001 020		CAIGE C,20.	;ENOUGH FOR NOW
   069	033 037		SOSG SWPOPR
   070	001 030		POPJ P,
   071	033 035	SWPU3:	MOVE B,PSWLC
   072	033 030		MOVE U,PSWOUS
   073	001 019	SWPU3A:	TRNE B,-2	;IN PAIRS SO DON'T TEST LOW BIT
   074	031 050		SOJA B,SWPU2
   075	001 019	SWPU7B:	TLON B,400000
   076	031 082		JRST SWPU7	;DO UDBR2
   077	033 030	SWPU7A:	SETOM PSWOUS
   078	001 019		MOVSI B,100000
   079	500 052		IORM B,USWST(U)	;SET BEST EFFORT BIT
   080	031 003		JRST SWPON
   081		
   082	500 051	SWPU7:	LDB C,[2300,,HUSRAD(U)]
   083	001 020		SUBI C,400000
   084	031 077		JUMPLE C,SWPU7A
   085	001 020		HRR B,C
   086	500 043		MOVE C,UDBR2(U)
   087	500 045		MOVE J,UCPB2(U)
   088	031 039		JRST SWPU7C
   089		
   090	001 031	SWPU1A:	MOVSI T,20000	;SWAPPING OUT PAGES OF PROCEDURE BLOCKED IN EXEC MODE
   091	500 052		IORM T,USWST(U)
   092	031 028		JRST SWPU1î   001		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  